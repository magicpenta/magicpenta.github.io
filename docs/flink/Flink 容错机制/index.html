<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-flink/Flink 容错机制">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.2.0">
<title data-rh="true">Flink 容错机制 | Panda Home</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://magicpenta.github.io/docs/flink/Flink 容错机制"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Flink 容错机制 | Panda Home"><meta data-rh="true" name="description" content="Checkpoint"><meta data-rh="true" property="og:description" content="Checkpoint"><link data-rh="true" rel="icon" href="/img/logo.svg"><link data-rh="true" rel="canonical" href="https://magicpenta.github.io/docs/flink/Flink 容错机制"><link data-rh="true" rel="alternate" href="https://magicpenta.github.io/docs/flink/Flink 容错机制" hreflang="en"><link data-rh="true" rel="alternate" href="https://magicpenta.github.io/docs/flink/Flink 容错机制" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Panda Home RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Panda Home Atom Feed"><link rel="stylesheet" href="/assets/css/styles.05fef033.css">
<link rel="preload" href="/assets/js/runtime~main.e2f7f3df.js" as="script">
<link rel="preload" href="/assets/js/main.4ed9c8f6.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#docusaurus_skipToContent_fallback">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="Panda Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/logo.svg" alt="Panda Logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">Panda Home</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs">Docs</a><a class="navbar__item navbar__link" href="/blog">Blog</a><a class="navbar__item navbar__link" href="/about">About</a></div><div class="navbar__items navbar__items--right"><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebar_njMd"><nav class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="true" href="/docs/">Spark</a><button aria-label="Toggle the collapsible sidebar category &#x27;Spark&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/spark/Spark 快速入门">Spark 快速入门</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/spark/Spark 集群部署">Spark 集群部署</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/spark/Spark 应用提交">Spark 应用提交</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/spark/Spark RDD">Spark RDD</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/spark/Spark 共享变量">Spark 共享变量</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/spark/Spark 任务调度">Spark 任务调度</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/spark/Spark Shuffle">Spark Shuffle</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/spark/Spark Streaming 入门指南">Spark Streaming 入门指南</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/spark/Spark Streaming 集成 Kafka">Spark Streaming 集成 Kafka</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/docs/flink/">Flink</a><button aria-label="Toggle the collapsible sidebar category &#x27;Flink&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/flink/Flink 快速入门">Flink 快速入门</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/flink/Flink 工作流程剖析">Flink 工作流程剖析</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/flink/Flink DataStream API">Flink DataStream API</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/flink/Flink Window">Flink Window</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/flink/Flink Watermark">Flink Watermark</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/flink/Flink 状态管理">Flink 状态管理</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/flink/Flink 容错机制">Flink 容错机制</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="true" href="/docs/clickhouse/">ClickHouse</a><button aria-label="Toggle the collapsible sidebar category &#x27;ClickHouse&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/clickhouse/ClickHouse 安装与启动">ClickHouse 安装与启动</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/clickhouse/ClickHouse JDBC">ClickHouse JDBC</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/clickhouse/ClickHouse 数据类型">ClickHouse 数据类型</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/clickhouse/ClickHouse 表引擎">ClickHouse 表引擎</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/clickhouse/ClickHouse SQL">ClickHouse SQL</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="true" href="/docs/flume/">Flume</a><button aria-label="Toggle the collapsible sidebar category &#x27;Flume&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/flume/Flume 集群部署（Docker）">Flume 集群部署（Docker）</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/flume/Flume 配置指南">Flume 配置指南</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/flume/Flume 负载均衡选择器">Flume 负载均衡选择器</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/flume/Flume ElasticSearch Sink">Flume ElasticSearch Sink（异步）</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/flume/Flume 自定义监控">Flume 自定义监控</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="true" href="/docs/spider/">Java 爬虫</a><button aria-label="Toggle the collapsible sidebar category &#x27;Java 爬虫&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/spider/使用 HttpClient 实现页面源码下载">使用 HttpClient 实现页面源码下载</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/spider/页面解析详细指南">页面解析详细指南</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/spider/基于 HtmlParser 实现网页链接提取">基于 HtmlParser 实现网页链接提取</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/spider/一个简易 Java 爬虫程序的实现">一个简易 Java 爬虫程序的实现</a></li></ul></li></ul></nav></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_OVgt"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/flink/"><span itemprop="name">Flink</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Flink 容错机制</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h1>Flink 容错机制</h1><h2 class="anchor anchorWithStickyNavbar_LWe7" id="checkpoint">Checkpoint<a class="hash-link" href="#checkpoint" title="Direct link to heading">​</a></h2><p>想一下，对于流计算框架来说，如果没有容错机制，会发生什么？当我们的应用程序因网络、硬件等不可抗力崩溃时，不存在恢复的选项，只能从数据源起点重新消费重新计算。这不仅会导致资源的浪费，还会直接影响实时指标。</p><p>为了保证容错，Flink 提供了 <strong>checkpoint</strong> 与 <strong>流重放</strong> 相结合的方式。</p><p>checkpoint 中文名为检查点，它每隔一定时间就会绘制一份分布式数据流的 snapshot（快照），这份快照包含了数据流中所有任务在 <strong>某个时间点</strong> 的状态信息。</p><p>checkpoint 默认不开启，需要在代码里启用：</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token class-name">StreamExecutionEnvironment</span><span class="token plain"> env </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getExecutionEnvironment</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">env</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">enableCheckpointing</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">5000</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>其中，<code>5000</code> 表示 checkpoint 的周期，单位为 <code>ms</code>。</p><div class="theme-admonition theme-admonition-info alert alert--info admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_S0QG"><p>checkpoint 是需要耗费时间和资源的，耗费的量级与 State 的大小有关。若 State 较小，checkpoint 过程就比较轻量，对数据流的处理不会产生影响；若 State 较大，checkpoint 过程可能就比较长，便需要考虑周期、时间间隔等。</p></div></div><div class="theme-admonition theme-admonition-info alert alert--info admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_S0QG"><p>checkpoint 支持异步执行，这样我们的程序在 checkpoint 的过程中不至于出现应用暂停的结果。</p></div></div><p>现在，我们以一个数据流示意图，来展示 checkpoint 的具体过程：</p><p><img loading="lazy" src="/assets/images/checkpoint_demo-4c136d48230a2cf49206ada8a7c4bd60.svg" width="663" height="315" class="img_ev3q"></p><div class="theme-admonition theme-admonition-caution alert alert--warning admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>caution</div><div class="admonitionContent_S0QG"><p>图中的红色虚线表示 Barrier，其含义与作用请见下文。</p></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="in-flight-state--state-snapshot">In-flight State &amp; State Snapshot<a class="hash-link" href="#in-flight-state--state-snapshot" title="Direct link to heading">​</a></h3><p>前文提到，checkpoint 会生成状态快照（State Snapshot），那么它与我们一直说的 State 是一个东西吗？</p><p>实际上，我们可以将 State 区分为 In-flight State 和 State Snapshot。</p><p>In-flight State 又称运行期状态，是 Flink 作业运行过程中产生的状态，与 checkpoint 无关。它通常是由 State Backend 存储在本地内存中的，在某些情况下也可能输出到本地磁盘。由于与 checkpoint 无关，这种状态确实有丢失的可能性，但不会影响服务的恢复。</p><p>State Snapshot 即为状态快照，是 checkpoint 期间记录的某个时间点下的状态信息，通常会被存储到外部存储器。State Snapshot 的存储过程可参考下图：</p><p><img loading="lazy" src="/assets/images/checkpoints-cf2f4125aa619d52a7cb4f6665832daa.svg" width="482" height="369" class="img_ev3q"></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="barrier">Barrier<a class="hash-link" href="#barrier" title="Direct link to heading">​</a></h3><p>我们已经知道，checkpoint 会记录数据流在某个时间点的快照信息，那么，一个有趣的问题就来了：从 checkpoint 触发开始到 checkpoint 成功生成快照的这个过程里，Flink 是怎么知道流入的数据有哪些是需要在当前 checkpoint 阶段进行“拍照”的？</p><p>这就不得不提到 checkpoint 中的核心元素：<strong>Barrier（流屏障）</strong>。</p><p>Barrier 同 Watermark 一样：</p><ul><li><strong>本质上也是一种随数据流流动的数据</strong></li><li>以广播的方式向下游传递</li></ul><p>它可以标记 checkpoint 的分界线，将数据流中的元素划分为分属不同 checkpoint 周期的数据集，如下图所示：</p><p><img loading="lazy" src="/assets/images/stream_barriers-995aca19640dea1c8ecba7ef3f2d6030.svg" width="553" height="200" class="img_ev3q"></p><p>图中，存在两个屏障 <em>barrier n-1</em> 和 <em>barrier n</em> 以及 3 个检查周期 <em>checkpoint n-1</em>、<em>checkpoint n</em> 和 <em>checkpoint n+1</em>。</p><p>当 <em>barrier n</em> 注入到数据流时，表示其所对应的 <em>checkpoint n</em> 已经可以确认边界了。Flink 会在 <em>barrier n</em> 流经下游任务时触发“拍照”动作，并在所有任务都“拍”完后告知 JobManager，完成 checkpoint 并存储快照。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="aligned-checkpoint">Aligned Checkpoint<a class="hash-link" href="#aligned-checkpoint" title="Direct link to heading">​</a></h3><p>在单并行度数据流中，Barrier 的处理方式比较简单，但是在多并行度数据流里，Barrier 的处理便需要考虑更多细节。</p><p>根据 Barrier 在多个并行子任务的处理方式，我们可以将 Checkpoint 划分为 Aligned Checkpoint 和 Unaligned Checkpoint。两者的区别在于：<strong>是否需要在并行子任务中对 Barrier 进行对齐</strong>。</p><p>顾名思义，Aligned Checkpoint 表示 Barrier 需要一个对齐的过程，其 checkpoint 过程如下图所示：</p><p><img loading="lazy" src="/assets/images/stream_aligning-d487d2810bf9f794a464bdd4b00dd9d1.svg" width="1311" height="291" class="img_ev3q"></p><p>用文字表述完整的流程：</p><ol><li>JobManager 发起 checkpoint</li><li>应用程序从 Source 开始创建带有 checkpoint ID 的 barrier，barrier 生成后以广播形式向多个下游子任务传递</li><li>本例中数字流（元素为阿拉伯数字）的 barrier 先抵达 Operator，进入 <strong>等待对齐状态</strong></li><li>字母流的 barrier 在一段时间后也抵达 Operator</li><li>Operator 确认所有 barrier 已对齐，计算结果存储至 state，并拷贝到 State Backend</li><li>TaskManager 将状态快照传输至 checkpoint 存储器，并通知 JobManager 当前任务的 checkpoint 已完成</li><li><strong>当所有任务均确认完毕，说明本轮 checkpoint 已完成</strong></li></ol><div class="theme-admonition theme-admonition-info alert alert--info admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_S0QG"><p>在对齐等待期间，barrier 之后的数据 <strong>会先被缓存，不会被计算</strong>，等到其他线路的 barrier 都对齐后，这些缓存的数据才会继续往下流。</p></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="checkpoint-storage">Checkpoint Storage<a class="hash-link" href="#checkpoint-storage" title="Direct link to heading">​</a></h3><p>当状态快照（State Snapshot）生成时，它需要被持久化保存，才能在服务异常时提供可靠的恢复点。</p><p>状态快照（State Snapshot）保存的位置，便称为 Checkpoint Storage。</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="jobmanagercheckpointstorage">JobManagerCheckpointStorage<a class="hash-link" href="#jobmanagercheckpointstorage" title="Direct link to heading">​</a></h4><p>顾名思义，JobManagerCheckpointStorage 将状态快照保存在 JobManager 的内存堆中。它具有以下特点：</p><ul><li>状态读写速度快</li><li>受内存限制，有 OOM 的风险</li><li>默认情况下，单个状态的大小不能超过 <code>5M</code></li></ul><p>大多数情况下，JobManagerCheckpointStorage 只在本地开发或测试时使用。</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="filesystemcheckpointstorage">FileSystemCheckpointStorage<a class="hash-link" href="#filesystemcheckpointstorage" title="Direct link to heading">​</a></h4><p>FileSystemCheckpointStorage 会把状态快照保存到 <code>checkpointDirectory</code> 指向的存储器上：</p><ul><li>该存储器可以是本地磁盘，如：<code>file:///data/flink/checkpoints</code></li><li>也可以是远程存储，如：<code>hdfs://namenode:40010/flink/checkpoints</code></li></ul><p>相对 JobManagerCheckpointStorage，<strong>FileSystemCheckpointStorage 的可靠性更高</strong>，但在读写速度上逊色不少。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="retained-checkpoint">Retained Checkpoint<a class="hash-link" href="#retained-checkpoint" title="Direct link to heading">​</a></h3><p>默认情况下，Checkpoint 不是永久保存的，当我们的作业取消后，checkpoint 文件会被删除。若想保存 checkpoint 文件，可以修改清理模式：</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token class-name">CheckpointConfig</span><span class="token plain"> config </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> env</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getCheckpointConfig</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">config</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">enableExternalizedCheckpoints</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">ExternalizedCheckpointCleanup</span><span class="token punctuation" style="color:#393A34">.</span><span class="token constant" style="color:#36acaa">RETAIN_ON_CANCELLATION</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>ExternalizedCheckpointCleanup 中包含了两种模式：</p><ul><li>DELETE_ON_CANCELLATION：Flink 作业取消后删除 checkpoint 文件</li><li>RETAIN_ON_CANCELLATION：Flink 作业取消后保留 checkpoint 文件</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="recovery">Recovery<a class="hash-link" href="#recovery" title="Direct link to heading">​</a></h3><p>当作业出现故障时，Flink 会停止分布式数据流，将数据流重置到 checkpoint 最新生成的快照上，并根据这份快照完成各个任务状态的恢复。</p><p>在这个过程中，有两种策略需要了解，它们分别是：Restart 和 Failover。</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="restart-strategy">Restart Strategy<a class="hash-link" href="#restart-strategy" title="Direct link to heading">​</a></h4><p>Restart Strategy 译为重启策略，它关注的是 <strong>时间上</strong> 的重启恢复行为。当作业出现异常时，Restart Strategy 决定了 <strong>是否重启作业</strong> 以及 <strong>何时重启作业</strong>。</p><p>Restart Strategy 包含 4 种类型的策略：</p><table><thead><tr><th><strong>策略类型</strong></th><th><strong>策略说明</strong></th></tr></thead><tbody><tr><td>No Restart Strategy</td><td>不重启</td></tr><tr><td>Fixed Delay Restart Strategy</td><td>固定重启次数，超出尝试次数则作业失败</td></tr><tr><td>Failure Rate Restart Strategy</td><td>固定 <strong>周期内</strong> 重启次数，<strong>周期内</strong> 超出尝试次数则作业失败</td></tr><tr><td>Exponential Delay Restart Strategy</td><td>尝试 <strong>无限重启</strong> 的策略</td></tr></tbody></table><div class="theme-admonition theme-admonition-info alert alert--info admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_S0QG"><p>Exponential Delay Restart Strategy 的实现逻辑较为复杂。在作业运行过程中，每一次异常发生都会导致重启的延迟时间会倍增（由 <code>backoff-multiplier</code> 指定），直至达到预设的最大延迟时间。若指定阈值内未出现异常，重启延迟时间会恢复到最初值。</p></div></div><p>以 Fixed Delay Restart Strategy 为例，我们可以在配置文件 <code>flink-conf.yaml</code> 设置重启策略：</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">restart-strategy: fixed-delay</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">restart-strategy.fixed-delay.attempts: 3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">restart-strategy.fixed-delay.delay: 10 s</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>各配置项的说明可见下表：</p><table><thead><tr><th><strong>配置项</strong></th><th><strong>参数类型</strong></th><th><strong>默认值</strong></th><th><strong>配置说明</strong></th></tr></thead><tbody><tr><td>fixed-delay.attempts</td><td>Integer</td><td>1</td><td>重启尝试次数</td></tr><tr><td>fixed-delay.delay</td><td>Duration</td><td>1s</td><td>尝试重启的时间延迟</td></tr></tbody></table><p>当然，我们也可以在代码中直接设置重启策略：</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token class-name">ExecutionEnvironment</span><span class="token plain"> env </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">ExecutionEnvironment</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getExecutionEnvironment</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">env</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">setRestartStrategy</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">RestartStrategies</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">fixedDelayRestart</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">3</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// number of restart attempts</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token class-name">Time</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">of</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">10</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">TimeUnit</span><span class="token punctuation" style="color:#393A34">.</span><span class="token constant" style="color:#36acaa">SECONDS</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// delay</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="theme-admonition theme-admonition-info alert alert--info admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_S0QG"><p>如果 checkpoint 被禁用，重启策略为 none，即 no restart；如果 checkpoint 启用但是未显式设置重启策略，那么重启策略默认为 fixed-delay，且最大重试次数为 Integer.MAX_VALUE。</p></div></div><div class="theme-admonition theme-admonition-caution alert alert--warning admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>caution</div><div class="admonitionContent_S0QG"><p>开启 checkpoint 时，若出现异常，作业并不会直接失败退出，而是由重启策略决定是否退出。</p></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="failover-strategy">Failover Strategy<a class="hash-link" href="#failover-strategy" title="Direct link to heading">​</a></h4><p>Failover Strategy 译为故障转移策略，它关注的是 <strong>空间上</strong> 的重启恢复行为。当作业出现异常，Failover Strategy 决定应该 <strong>重启哪些任务</strong> 以恢复作业的运行。</p><p>Failover Strategy 包含两种类型的策略：</p><table><thead><tr><th><strong>策略类型</strong></th><th><strong>策略说明</strong></th></tr></thead><tbody><tr><td>Restart All</td><td>全量重启</td></tr><tr><td>Restart pipelined region</td><td>部分任务重启</td></tr></tbody></table><h3 class="anchor anchorWithStickyNavbar_LWe7" id="checkpoint-config">Checkpoint Config<a class="hash-link" href="#checkpoint-config" title="Direct link to heading">​</a></h3><p>除了已知的 checkpoint interval，checkpoint 还提供了丰富的配置参数，本节对一些常见配置作简要介绍：</p><table><thead><tr><th><strong>配置项</strong></th><th><strong>默认值</strong></th><th><strong>配置说明</strong></th></tr></thead><tbody><tr><td>checkpoint mode</td><td>EXACTLY_ONCE</td><td>checkpoint 的一致性模式</td></tr><tr><td>checkpoint timeout</td><td>600000 ms</td><td>checkpoint 超时时间</td></tr><tr><td>checkpoint failure number</td><td>-1</td><td>能容忍的 checkpoint 最大连续失败数</td></tr><tr><td>checkpoint max concurrent</td><td>1</td><td>允许的 checkpoint 最大并发数</td></tr><tr><td>checkpoint min pause</td><td>0</td><td>两个 checkpoint 间允许的最小时间间隔</td></tr><tr><td>checkpoint prefer for recovery</td><td>false</td><td>当同时存在 savepoint 时，是否更偏向于从 checkpoint 进行恢复</td></tr></tbody></table><h3 class="anchor anchorWithStickyNavbar_LWe7" id="unaligned-checkpoint">Unaligned Checkpoint<a class="hash-link" href="#unaligned-checkpoint" title="Direct link to heading">​</a></h3><p>Flink 1.11 版本后，提供了非对齐的 Checkpoint 机制。</p><p>在 Aligned Checkpoint 中，barrier 必须遵循自己在数据流中的位置，不可越界。<strong>在 Unaligned Checkpoint 中，barrier 便不再有这个限制，Flink 允许它超过位于它之前的元素，尽可能快地从 sink 端输出</strong>。</p><p>因为这个特性，Unaligned Checkpoint 的过程如下图所示：</p><p><img loading="lazy" src="/assets/images/stream_unaligning-763adc811a3d941fad2983a3b55ebff3.svg" width="1311" height="291" class="img_ev3q"></p><p>在这个过程中：</p><ol><li>Operator 会对输入缓存区（Input buffers）中的第一个 barrier 做出响应，立即将其添加到输出缓存区（Output buffers）</li><li>Operator 会 <strong>异步</strong> 存储所有标记为 <strong>被 barrier 超过</strong> 的数据，并创建自身的状态快照</li></ol><div class="theme-admonition theme-admonition-info alert alert--info admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_S0QG"><p>步骤 2 会短暂停止数据输入。</p></div></div><p>我们发现，在 Unaligned Checkpoint 中，barrier 的传输速度是远远快于 Aligned Checkpoint 的，在出现反压时，Unaligned Checkpoint 不会像 Aligned Checkpoint 那样由于 barrier 的积压而出现 checkpoint 失败的情况。<strong>这使得在反压的情况下，Unaligned Checkpoint 会具备更好的稳定性。</strong></p><p>当然，Unaligned Checkpoint 也并非是完美的：</p><ul><li>除了原有的状态之外，它还需要持久化缓存数据，对磁盘的负载会升高</li><li>其恢复作业的时间可能更长</li></ul><div class="theme-admonition theme-admonition-info alert alert--info admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_S0QG"><p>尽管 Unaligned Checkpoint 不存在对齐过程，但由于其在流重放的过程中会重放缓存数据，依然可以支持 EXACTLY_ONCE。</p></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="savepoint">Savepoint<a class="hash-link" href="#savepoint" title="Direct link to heading">​</a></h2><p>savepoint 中文名为保存点，提供手动触发 checkpoint 的功能。它的底层实现算法，与 checkpoint 基本上可以说是相同的，两者的主要区别在于：<br></p><ul><li>savepoint 由用户手动触发，checkpoint 由应用程序自动触发</li><li>checkpoint 会被更新的 checkpoint 覆盖，savepoint 不会</li><li>savepoint 仅支持对齐算法</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="trigger-a-savepoint">Trigger a Savepoint<a class="hash-link" href="#trigger-a-savepoint" title="Direct link to heading">​</a></h3><p>当 Flink 部署在独立集群时，用户可通过以下命令行手动触发 savepoint：</p><div class="language-Bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-Bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ bin/flink savepoint ${jobId} ${targetDirectory}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="trigger-a-savepoint-with-yarn">Trigger a Savepoint with YARN<a class="hash-link" href="#trigger-a-savepoint-with-yarn" title="Direct link to heading">​</a></h3><p>若 Flink 集群由 YARN 管理，则可以通过以下命令触发：</p><div class="language-Bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-Bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ bin/flink savepoint ${jobId} ${targetDirectory} -yid ${yarnAppId}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="theme-admonition theme-admonition-info alert alert--info admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_S0QG"><p><code>${jobId}</code> 表示作业 ID，<code>${targetDirectory}</code> 表示 Savepoint 存储路径，<code>${yarnAppId}</code> 表示 YARN 应用 ID。</p></div></div></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/flink/Flink 状态管理"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Flink 状态管理</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/clickhouse/"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">ClickHouse</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#checkpoint" class="table-of-contents__link toc-highlight">Checkpoint</a><ul><li><a href="#in-flight-state--state-snapshot" class="table-of-contents__link toc-highlight">In-flight State &amp; State Snapshot</a></li><li><a href="#barrier" class="table-of-contents__link toc-highlight">Barrier</a></li><li><a href="#aligned-checkpoint" class="table-of-contents__link toc-highlight">Aligned Checkpoint</a></li><li><a href="#checkpoint-storage" class="table-of-contents__link toc-highlight">Checkpoint Storage</a></li><li><a href="#retained-checkpoint" class="table-of-contents__link toc-highlight">Retained Checkpoint</a></li><li><a href="#recovery" class="table-of-contents__link toc-highlight">Recovery</a></li><li><a href="#checkpoint-config" class="table-of-contents__link toc-highlight">Checkpoint Config</a></li><li><a href="#unaligned-checkpoint" class="table-of-contents__link toc-highlight">Unaligned Checkpoint</a></li></ul></li><li><a href="#savepoint" class="table-of-contents__link toc-highlight">Savepoint</a><ul><li><a href="#trigger-a-savepoint" class="table-of-contents__link toc-highlight">Trigger a Savepoint</a></li><li><a href="#trigger-a-savepoint-with-yarn" class="table-of-contents__link toc-highlight">Trigger a Savepoint with YARN</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Recommend</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs">Spark</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/flink">Flink</a></li></ul></div><div class="col footer__col"><div class="footer__title">Other</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs/clickhouse">ClickHouse</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/flume">Flume</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/spider">Spider</a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/magicpenta" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">Legal</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://opensource.fb.com/legal/privacy/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Privacy<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://opensource.fb.com/legal/cookie-policy/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Cookie Policy<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="margin-bottom--sm"><img src="/img/bottom.png" alt="Panda Logo" class="themedImage_ToTc themedImage--light_HNdA footer__logo"><img src="/img/bottom.png" alt="Panda Logo" class="themedImage_ToTc themedImage--dark_i4oU footer__logo"></div><div class="footer__copyright">Copyright © 2023 Panda's Home</div></div></div></footer></div>
<script src="/assets/js/runtime~main.e2f7f3df.js"></script>
<script src="/assets/js/main.4ed9c8f6.js"></script>
</body>
</html>