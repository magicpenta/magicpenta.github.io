<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-spark/Spark RDD">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.2.0">
<title data-rh="true">Spark RDD | Panda Home</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://magicpenta.github.io/docs/spark/Spark RDD"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Spark RDD | Panda Home"><meta data-rh="true" name="description" content="RDD 基本概念"><meta data-rh="true" property="og:description" content="RDD 基本概念"><link data-rh="true" rel="icon" href="/img/logo.svg"><link data-rh="true" rel="canonical" href="https://magicpenta.github.io/docs/spark/Spark RDD"><link data-rh="true" rel="alternate" href="https://magicpenta.github.io/docs/spark/Spark RDD" hreflang="en"><link data-rh="true" rel="alternate" href="https://magicpenta.github.io/docs/spark/Spark RDD" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Panda Home RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Panda Home Atom Feed"><link rel="stylesheet" href="/assets/css/styles.05fef033.css">
<link rel="preload" href="/assets/js/runtime~main.e2f7f3df.js" as="script">
<link rel="preload" href="/assets/js/main.4ed9c8f6.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#docusaurus_skipToContent_fallback">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="Panda Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/logo.svg" alt="Panda Logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">Panda Home</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs">Docs</a><a class="navbar__item navbar__link" href="/blog">Blog</a><a class="navbar__item navbar__link" href="/about">About</a></div><div class="navbar__items navbar__items--right"><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebar_njMd"><nav class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/docs/">Spark</a><button aria-label="Toggle the collapsible sidebar category &#x27;Spark&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/spark/Spark 快速入门">Spark 快速入门</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/spark/Spark 集群部署">Spark 集群部署</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/spark/Spark 应用提交">Spark 应用提交</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/spark/Spark RDD">Spark RDD</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/spark/Spark 共享变量">Spark 共享变量</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/spark/Spark 任务调度">Spark 任务调度</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/spark/Spark Shuffle">Spark Shuffle</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/spark/Spark Streaming 入门指南">Spark Streaming 入门指南</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/spark/Spark Streaming 集成 Kafka">Spark Streaming 集成 Kafka</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="true" href="/docs/flink/">Flink</a><button aria-label="Toggle the collapsible sidebar category &#x27;Flink&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/flink/Flink 快速入门">Flink 快速入门</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/flink/Flink 工作流程剖析">Flink 工作流程剖析</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/flink/Flink DataStream API">Flink DataStream API</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/flink/Flink Window">Flink Window</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/flink/Flink Watermark">Flink Watermark</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/flink/Flink 状态管理">Flink 状态管理</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/flink/Flink 容错机制">Flink 容错机制</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="true" href="/docs/clickhouse/">ClickHouse</a><button aria-label="Toggle the collapsible sidebar category &#x27;ClickHouse&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/clickhouse/ClickHouse 安装与启动">ClickHouse 安装与启动</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/clickhouse/ClickHouse JDBC">ClickHouse JDBC</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/clickhouse/ClickHouse 数据类型">ClickHouse 数据类型</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/clickhouse/ClickHouse 表引擎">ClickHouse 表引擎</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/clickhouse/ClickHouse SQL">ClickHouse SQL</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="true" href="/docs/flume/">Flume</a><button aria-label="Toggle the collapsible sidebar category &#x27;Flume&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/flume/Flume 集群部署（Docker）">Flume 集群部署（Docker）</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/flume/Flume 配置指南">Flume 配置指南</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/flume/Flume 负载均衡选择器">Flume 负载均衡选择器</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/flume/Flume ElasticSearch Sink">Flume ElasticSearch Sink（异步）</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/flume/Flume 自定义监控">Flume 自定义监控</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="true" href="/docs/spider/">Java 爬虫</a><button aria-label="Toggle the collapsible sidebar category &#x27;Java 爬虫&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/spider/使用 HttpClient 实现页面源码下载">使用 HttpClient 实现页面源码下载</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/spider/页面解析详细指南">页面解析详细指南</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/spider/基于 HtmlParser 实现网页链接提取">基于 HtmlParser 实现网页链接提取</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/spider/一个简易 Java 爬虫程序的实现">一个简易 Java 爬虫程序的实现</a></li></ul></li></ul></nav></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_OVgt"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/"><span itemprop="name">Spark</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Spark RDD</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h1>Spark RDD</h1><h2 class="anchor anchorWithStickyNavbar_LWe7" id="rdd-基本概念">RDD 基本概念<a class="hash-link" href="#rdd-基本概念" title="Direct link to heading">​</a></h2><p>RDD，全称为 Resilient Distributed Dataset，翻译成中文叫做 <strong>弹性分布式数据集</strong>，是 Spark 中最重要的抽象概念，代表了一个不可变、可分区、支持并行计算的数据集合。它的设计理念源自 AMP 实验室发表的论文《Resilient Distributed Datasets: A Fault-Tolerant Abstraction for In-Memory Cluster Computing》。</p><div class="theme-admonition theme-admonition-info alert alert--info admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_S0QG"><p>虽然 RDD 被称为数据集，但实际上它只是封装了计算逻辑，并不保存数据。</p></div></div><p>从定义上来看，RDD 具有很多特性：</p><ul><li>弹性：RDD 的弹性主要体现在存储、计算、容错、分片等方面<ul><li>存储的弹性：内存不足时可以和磁盘进行数据交换</li><li>计算的弹性：计算出错时具有重试机制</li><li>容错的弹性：数据丢失可自动恢复</li><li>分片的弹性：可根据需要重新分片</li></ul></li><li>不可变（只读）：RDD 是只读的，创建后不可修改，只能通过转换操作（<code>map</code>、<code>join</code> 等）生成新的 RDD</li><li>可分区：RDD 可以分成多个分区，每个分区对应大数据集群上的一个数据片段</li><li>支持并行计算：RDD 的不同分区可对应集群上不同节点的数据片段，进而支持并行计算</li></ul><p>在代码层面，RDD 是一个抽象类，主要有 5 个核心方法：</p><table><thead><tr><th><strong>名称</strong></th><th><strong>含义</strong></th></tr></thead><tbody><tr><td>getPartitions</td><td>由子类实现，返回一个分区列表，用于执行并行计算</td></tr><tr><td>compute</td><td>由子类实现，是一个用于 <strong>计算每一个分区</strong> 的 <strong>函数</strong></td></tr><tr><td>getDependencies</td><td>由子类实现，获取当前 RDD 的依赖关系</td></tr><tr><td>partitioner</td><td>由子类实现（可选），可设置分区器对数据集进行分区（仅适用于 KV 类型的 RDD）</td></tr><tr><td>getPreferredLocations</td><td>由子类实现（可选），可在分区计算时指定 <strong>优先起始位置</strong>，有助于“移动计算”的实现</td></tr></tbody></table><div class="theme-admonition theme-admonition-caution alert alert--warning admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>caution</div><div class="admonitionContent_S0QG"><p>compute 方法通常用于执行算子中用户编写的函数 func，但有时它又只返回了迭代器，并不执行计算，更多细节请见 《Spark 任务调度》中的内容。</p></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="rdd-创建">RDD 创建<a class="hash-link" href="#rdd-创建" title="Direct link to heading">​</a></h2><p>RDD 可以基于已存在的集合创建：</p><div class="language-scala codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-scala codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">val</span><span class="token plain"> array</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Array</span><span class="token punctuation" style="color:#393A34">[</span><span class="token builtin">Int</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Array</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">4</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">5</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">val</span><span class="token plain"> rdd</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> RDD</span><span class="token punctuation" style="color:#393A34">[</span><span class="token builtin">Int</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> sc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">parallelize</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">array</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>它也可以基于外部存储系统的数据集创建，包括本地文件系统、Hadoop 支持的数据集（HDFS、HBase 等），例如：</p><div class="language-scala codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-scala codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">val</span><span class="token plain"> lines</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> RDD</span><span class="token punctuation" style="color:#393A34">[</span><span class="token builtin">String</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> sc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">textFile</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;data/my.txt&quot;</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>需要补充的是，Spark 在读取外部文件时：</p><ul><li>支持目录级别读取：<code>testFile(&quot;data/&quot;)</code></li><li>支持通配符读取：<code>testFile(&quot;data/*&quot;)</code> 或 <code>testFile(&quot;data/*.txt&quot;)</code></li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="rdd-分区">RDD 分区<a class="hash-link" href="#rdd-分区" title="Direct link to heading">​</a></h2><p>分区是 RDD 中最重要的核心属性。一方面，它存储了数据片段在大数据集群所处的位置；另一方面，它的数量与计算效率息息相关。</p><p>分区对计算效率的影响主要在于 CPU 的利用率。举例说明，假设 Spark 集群支持 100 的并行度，且有分区数为 1 的 RDD，由于该 RDD 的分区数较小，其拆解出的计算任务数也偏小，实际计算时将无法充分利用集群的 CPU 资源。相反，若此时有分区数为 100 的 RDD，那么其拆解出的计算任务将尽可能地占满集群的 CPU 资源。</p><div class="theme-admonition theme-admonition-info alert alert--info admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_S0QG"><p>并行度指计算集群支持并行计算的任务数量，通常希望与集群的 CPU 总核数保持一致。</p></div></div><p>知道分区的重要性后，我们再来究其本质。前文提到过，RDD 分区对应的其实是大数据集群上的一个数据片段。这个数据片段，与文件系统上的文件并非是一一对应的关系。<strong>它是由 InputFormat 实现类根据一定规则对数据文件进行切分的结果。</strong>以读取 HDFS 文件为例，这个切分的过程如下所示：</p><p><img loading="lazy" src="/assets/images/split-312de5179bcec7c62667bed3037c4b1d.svg" width="1541" height="883" class="img_ev3q"></p><p>该过程的核心在于步骤 4，即计算 split 的大小。<strong>split 的大小将直接影响一个数据文件会被切分成多少个片段，并最终影响 RDD 的分区数。</strong>在 HadoopRDD 中，split 由 <code>minPartitions</code> 根据一定运算规则计算得来，<code>minPartitions</code> 可以在创建 RDD 时通过参数指定。</p><div class="theme-admonition theme-admonition-caution alert alert--warning admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>caution</div><div class="admonitionContent_S0QG"><p>RDD 的实现类有很多，相应地，split 的计算规则也各不相同。例如，在 DataFrame 的 FileScanRDD 中，split 的大小与默认并行度 <code>spark.default.parallelism</code> 有关。</p></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="rdd-算子">RDD 算子<a class="hash-link" href="#rdd-算子" title="Direct link to heading">​</a></h2><p>对 RDD 数据的操作称为算子，它含有两种类型，分别是 <strong>转换算子</strong> 和 <strong>行动算子</strong>。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="转换算子">转换算子<a class="hash-link" href="#转换算子" title="Direct link to heading">​</a></h3><p>转换算子（transformations）会基于已存的 RDD 创建出新的 RDD，如下图所示：</p><p><img loading="lazy" src="/assets/images/transform-0dd0ec352696158a0266eeebb8ef10cc.svg" width="1262" height="522" class="img_ev3q"></p><p>其中，<code>flatMap</code> 和 <code>map</code> 便属于转换算子，前者负责对数据进行切分展开，后者负责数据的映射转换。需要注意的是，转换算子是惰性的，<strong>仅记录 RDD 的转换逻辑，不会触发计算</strong>。</p><p>下表是一些常见的 RDD 转换算子：</p><table><thead><tr><th><strong>操作</strong></th><th><strong>含义</strong></th></tr></thead><tbody><tr><td><strong>filter</strong>(<em>func</em>)</td><td>筛选出满足条件的元素，并返回一个新的数据集</td></tr><tr><td><strong>map</strong>(<em>func</em>)</td><td>将每个元素传递到函数 <em>func</em> 中，返回一个新的数据集，每个输入元素会映射到 <strong>1 个输出结果</strong></td></tr><tr><td><strong>flatMap</strong>(<em>func</em>)</td><td>与 map 相似，但每个输入元素都可以映射到 <strong>0 或多个输出结果</strong></td></tr><tr><td><strong>mapPartitions</strong>(<em>func</em>)</td><td>与 map 相似，但是传递给函数 <em>func</em> 的是每个分区数据集对应的迭代器</td></tr><tr><td><strong>distinct</strong>(<em>func</em>)</td><td>对原数据集进行去重，并返回新的数据集</td></tr><tr><td><strong>groupByKey</strong>(<em>[numPartitions]</em>)</td><td>应用于 (K, V) 形式的数据集，返回一个新的 (K, Iterable&lt;V<!-- -->&gt;<!-- -->) 形式的数据集，可通过 <em>numPartitions</em> 指定新数据集的分区数</td></tr><tr><td><strong>reduceByKey</strong>(<em>func</em>, <em>[numPartitions]</em>)</td><td>应用于 (K, V) 形式的数据集，返回一个新的 (K, V) 形式的数据集，新数据集中的 V 是原有数据集中每个 K 对应的 V 传递到 <em>func </em>中进行聚合后的结果</td></tr><tr><td><strong>aggregateByKey</strong>(<em>zeroValue</em>)(<em>seqOp</em>, <em>combOp</em>, <em>[numPartitions]</em>)</td><td>应用于 (K, V) 形式的数据集，返回一个新的 (K, U) 形式的数据集，新数据集中的 U  是原有数据集中每个 K 对应的 V 传递到 <em>seqOp</em> 与 <em>combOp</em> 的联合函数且与 <em>zeroValue</em> 聚合后的结果</td></tr><tr><td><strong>sortByKey</strong>(<em>[ascending]</em>, <em>[numPartitions]</em>)</td><td>应用于 (K, V) 形式的数据集，返回一个根据 K 排序的数据集，K 按升序或降序排序由  <em>ascending</em> 指定</td></tr><tr><td><strong>union</strong>(<em>func</em>)</td><td>将两个数据集中的元素合并到一个新的数据集</td></tr><tr><td><strong>join</strong>(<em>func</em>)</td><td>表示内连接，对于给定的两个形式分别为 (K, V) 和 (K, W) 的数据集，只有在两个数据集中都存在的 K 才会被输出，最终得到一个 (K, (V, W)) 类型的数据集</td></tr><tr><td><strong>repartition</strong>(<em>numPartitions</em>)</td><td>对数据集进行重分区，新的分区数由 <em>numPartitions</em> 指定</td></tr></tbody></table><div class="theme-admonition theme-admonition-info alert alert--info admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_S0QG"><p>上表部分转换算子的概念看起来较为复杂，因此对该部分算子进行补充说明。</p></div></div><hr><p><strong>关于 <code>map</code> 和 <code>mapPartitions</code>：</strong></p><ul><li>本质区别在于输入给函数 func 的对象不同，前者是 RDD 中的元素，后者是 RDD 分区数据集对应的迭代器。</li><li>假如某个 RDD 有 n 个分区，所有分区共有 m 个元素，那么该 RDD 调用 <code>map</code> 算子时会触发 m 次 func，而调用 <code>mapPartition</code> 时只会触发 n 次 func。在这种区别下，当函数 func 中存在创建连接、读取文件等耗费资源的步骤时，<code>mapPartition</code> 的性能会比 <code>map</code> 更好。 </li></ul><hr><p><strong>关于 <code>aggregateByKey</code>：</strong></p><ul><li><code>seqOp</code> 和 <code>combOp</code> 表示一个组合函数，前者指定分区内数据的聚合方式，后者指定分区间数据的聚合方式。</li><li><code>zeroValue</code> 的类型决定了新 RDD 中 V 的类型，且每个分区相同 K 的数据聚合后会添加上 <code>zeroValue</code> 的值。</li></ul><p>假设有如下 <code>aggregateByKey</code> 算子：</p><div class="language-scala codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-scala codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">val</span><span class="token plain"> agg</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> RDD</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">(</span><span class="token builtin">String</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token builtin">Int</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> wordMap</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">aggregateByKey</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> y</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">=&gt;</span><span class="token plain"> x </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> y</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> y</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">=&gt;</span><span class="token plain"> x </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> y</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>当我们输入下图中的 RDD 时，会有如下转换结果：</p><p><img loading="lazy" src="/assets/images/aggre-d10532265a44b40e0ab3587a9de9cade.svg" width="2125" height="997" class="img_ev3q"></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="行动算子">行动算子<a class="hash-link" href="#行动算子" title="Direct link to heading">​</a></h3><p>行动算子（actions）不返回新的 RDD，但是它会 <strong>触发计算任务的执行</strong>。以 <code>collect()</code> 算子为例，当它执行后，会向 Spark 发起一个启动计算任务的指令：</p><div class="language-scala codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-scala codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> collect</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Array</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">T</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> withScope </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">val</span><span class="token plain"> results </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> sc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">runJob</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">iter</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Iterator</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">T</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">=&gt;</span><span class="token plain"> iter</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">toArray</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Array</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">concat</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">results</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> _</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>行动算子触发计算任务后，Spark 才开始分析之前的转换算子并生成 DAG，然后根据 DAG 拆解出实际的计算任务，最终执行计算并将结果返回给 Driver。这种设计，使 Spark 的计算效率得到了显著的提高。</p><p>下表是一些常见的 RDD 行动算子：</p><table><thead><tr><th><strong>操作</strong></th><th><strong>含义</strong></th></tr></thead><tbody><tr><td><strong>count</strong>()</td><td>返回数据集中的元素个数</td></tr><tr><td><strong>countByKey</strong>()</td><td>仅适用于 (K, V) 形式的数据集，以 (K, Int) 形式的 Map 返回每个 K 的元素个数</td></tr><tr><td><strong>collect</strong>()</td><td>以数组的形式返回数据集中的所有元素</td></tr><tr><td><strong>first</strong>()</td><td>返回数据集中的第一个元素</td></tr><tr><td><strong>take</strong>(<em>n</em>)</td><td>以数组的形式返回数据集中的前 <em>n</em> 个元素</td></tr><tr><td><strong>reduce</strong>(<em>func</em>)</td><td>通过函数 <em>func</em>（输入两个参数并返回一个值）聚合数据集中的元素</td></tr><tr><td><strong>foreach</strong>(<em>func</em>)</td><td>将数据集中的每个元素传递到函数 <em>func </em>中运行</td></tr><tr><td><strong>saveAsTextFile</strong>(<em>path</em>)</td><td>将数据集以文本格式写到本地磁盘或 HDFS 的指定目录下</td></tr><tr><td><strong>saveAsSequenceFile</strong>(<em>path</em>)</td><td>将数据集以 SequenceFile 格式写到本地磁盘或 HDFS 的指定目录下，仅适用于 (K, V) 形式且 K 和 V 均实现了 Hadoop Writable 接口的数据集</td></tr><tr><td><strong>saveAsObjectFile</strong>(<em>path</em>)</td><td>将数据集序列化成对象保存至本地磁盘或 HDFS 的指定目录下</td></tr></tbody></table><h2 class="anchor anchorWithStickyNavbar_LWe7" id="rdd-依赖关系">RDD 依赖关系<a class="hash-link" href="#rdd-依赖关系" title="Direct link to heading">​</a></h2><p>在计算逻辑中，不可避免的会出现 RDD 转换的过程，即旧的 RDD 调用转换算子生成新的 RDD。</p><p>通常，我们称旧 RDD 为父 RDD，新 RDD 为子 RDD。在这个转换的过程里，新旧 RDD 自然会建立起类似父子的联系，这个联系从概念来说便是 RDD 的依赖关系，在代码层面由抽象类 <strong>Dependency </strong>表示。</p><p>为了更直观地理解 RDD 的依赖关系及产生过程，我们可以参考 RDD 的创建方法 <code>sc.textFile(...)</code>：</p><div class="language-scala codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-scala codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// 代码片段 1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> textFile</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    path</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">String</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    minPartitions</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">Int</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> defaultMinPartitions</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> RDD</span><span class="token punctuation" style="color:#393A34">[</span><span class="token builtin">String</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> withScope </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// 创建 HadoopRDD，并调用 map 算子转换成 MapPartitionsRDD</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  hadoopFile</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">path</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> classOf</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">TextInputFormat</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> classOf</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">LongWritable</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> classOf</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">Text</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    minPartitions</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">map</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">pair </span><span class="token keyword" style="color:#00009f">=&gt;</span><span class="token plain"> pair</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">_2</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">toString</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">setName</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">path</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// 代码片段 2</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> hadoopFile</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">K</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> V</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    path</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">String</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    inputFormatClass</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Class</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">_ </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> InputFormat</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">K</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> V</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    keyClass</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Class</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">K</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    valueClass</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Class</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">V</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    minPartitions</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">Int</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> defaultMinPartitions</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> RDD</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">K</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> V</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> withScope </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> HadoopRDD</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    confBroadcast</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Some</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">setInputPathsFunc</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    inputFormatClass</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    keyClass</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    valueClass</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    minPartitions</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">setName</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">path</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// 代码片段 3</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> map</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">U</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> ClassTag</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">f</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> T </span><span class="token keyword" style="color:#00009f">=&gt;</span><span class="token plain"> U</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> RDD</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">U</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> withScope </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> MapPartitionsRDD</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">U</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> T</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">_</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> _</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> iter</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">=&gt;</span><span class="token plain"> iter</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">map</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">cleanF</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// 代码片段 4</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">private</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">spark</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> MapPartitionsRDD</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">U</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> ClassTag</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> T</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> ClassTag</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> prev</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> RDD</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">T</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    f</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">TaskContext</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token builtin">Int</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> Iterator</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">T</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">=&gt;</span><span class="token plain"> Iterator</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">U</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// (TaskContext, partition index, iterator)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    preservesPartitioning</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">Boolean</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    isFromBarrier</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">Boolean</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    isOrderSensitive</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">Boolean</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">extends</span><span class="token plain"> RDD</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">U</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">prev</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// 代码片段 5</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">(</span><span class="token annotation punctuation" style="color:#393A34">@transient</span><span class="token plain"> oneParent</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> RDD</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">_</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">oneParent</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">context</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> List</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> OneToOneDependency</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">oneParent</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>在这个创建 RDD 的方法中，具体会经历以下几个步骤：</p><ol><li>调用 <code>hadoopFile</code> 方法创建 HadoopRDD</li><li>由 HadoopRDD 调用 <code>map</code> 算子转换生成 MapPartitionsRDD</li><li>MapPartitionsRDD 生成时，会通过父类 RDD 中的 <code>this(...)</code> 方法创建与 HadoopRDD 间的依赖关系</li></ol><p>这个过程，我们也可以通过图例来表示：</p><p><img loading="lazy" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiB2ZXJzaW9uPSIxLjEiIHdpZHRoPSIxNzI1cHgiIGhlaWdodD0iMTY0cHgiIHZpZXdCb3g9Ii0wLjUgLTAuNSAxNzI1IDE2NCIgY29udGVudD0iJmx0O214ZmlsZSBzY2FsZT0mcXVvdDsyJnF1b3Q7IGJvcmRlcj0mcXVvdDszMCZxdW90OyZndDsmbHQ7ZGlhZ3JhbSBpZD0mcXVvdDswUWh0d3FNanBtY19BTy1NclJiNCZxdW90OyBuYW1lPSZxdW90O+esrCAxIOmhtSZxdW90OyZndDs3VmxOYzVzd0VQMDFubWtQeVFnRUdCOFRPMjR1YVR0Tlpwb2VaWkJCRTRHb0xNZDJmMzBsV0JrSU9FbGJ4K05Pek1IV1B1MmlqN2VyQi9ZQWo3UDFKMG1LOUViRWxBOWNGSzhIZURKd1hjZjFYZjFsa0UyRkRKMVJCU1NTeGVCVUE3ZnNGd1VRQWJwa01WMjBISlVRWExHaURVWWl6Mm1rV2hpUlVxemFiblBCMjZNV0pLRWQ0RFlpdkl0K1o3RktBUTE4cis2NHBpeEpZV2dYNDZEcXlZajFocVVzVWhLTFZRUENWd004bGtLb3FwV3R4NVNiM2JNYlU4Vk5kL1J1WnlacHJsNFQ0QTZIVmNnajRVdFlIc3hNYmV4NnBWam1NVFVSemdCZnJsS202RzFCSXRPNzBneHJMRlVaaCs2NXlOV1VaSXdiY3U5SUtqSUNLQkRwdUdDUEJSZXlIQUZqejNkOXJQR0ZrdUpodTZ1bEorTzg0WGsxbWJwVGIrdHBlM0tSNjN0ZkVobkJLRDdTSml5TlNrWFhPemZJMlc2N1RsZ3FNcXJrUnJ0QVFHQ1pnbHpGbzNNOFJJM0xyN3BYZFNLNEdFTFNSZzc0Z0JISXZXUTdVczJPYmdCQk84Z2FPUjF1YUt4VEUwd2hWU29Ta1JOK1ZhTk5idWlhcVh2ZFJ0RCtZZHJuUGxpVGRhTnJzckZHcm1kNWIyOWdqRWFVTWV1dzBxcmo0Z3RUYTlxY2NSRTlWTkNVY1R1Wk5vR2EybEY1YldrekszdWVOTDBSWWlramFsTTVoTE9BeUlUYTBndFJQNzJTY3FMWVkzdUVmeUxIRHQrcXBJQXJ5UGJ5UExKckRYNHVUWVhybGVKNWVUVWhOQ2V3Sm90ZFUvNUlGWXRJeTYzT0FndHlsdE16bTNVWDJzVkJldmwrTXlwSXpIZE05VkVKazlNTHErWlhkUjExOVQveGZQdnF4KzNxOTE2dS9xQ24rUEUraW44NCtxdjhnaTNycE1BTktiNFNxWmhpSWw5OG0weGVtdzU2TTFXYjgxNHVtc1JaZWpoTGNtMXlPamQzTU1Ub2xPWVhBR2NzanNzRHF5L0Y2aVJFTnA5Z1NzNGVhQjZpTnMyKzl5TE5qdGZEczdzUG5rTjBVdVRueU1MQk1Ta3k2bkJ6VXVTdElvZjI2YnlseVBoUWlteUhQNVFpVnllbWpPT1R0TDZpaklmSEk2Mmh1ek5SRmdYSmU1KzFJSFhNVTVaTVpoL01PNjJlaWg0TGhZMG0vdGhOa0M4NXZSUDZZMElMWFg4MGp6YU5mS25HZTBmYTYzbkhwTDM0cEwzUGtlV2dIdTA5cE54MjZUakpiUzIzWHAvY2hnZVRXKyt3Y250NkFUNUF3VHRIcE5MK1c2cDB0V0hJU093WnFLV0ppdlJHVWRsTm9Hc1NDMUcwMzV2Zm5YWTc0VEZwOSs3ZjMyWTFLeFhBTFBDWjhRYUI3S21meG1iL3hibHc2QWVCUC85VjNOL1BNNEUyNjM5SHlyN0duMHo0NmpjPSZsdDsvZGlhZ3JhbSZndDsmbHQ7L214ZmlsZSZndDsiPjxkZWZzLz48Zz48cmVjdCB4PSIxMjMyIiB5PSIzMC43NCIgd2lkdGg9IjQ2MCIgaGVpZ2h0PSIxMDAiIHJ4PSI1MCIgcnk9IjUwIiBmaWxsPSIjZWRmMmY0IiBzdHJva2U9Im5vbmUiIHBvaW50ZXItZXZlbnRzPSJhbGwiLz48cGF0aCBkPSJNIDEyNTIgODAuNzQgTCAxMTg4LjI0IDgwLjc0IiBmaWxsPSJub25lIiBzdHJva2U9IiM5OTk5OTkiIHN0cm9rZS13aWR0aD0iMiIgc3Ryb2tlLW1pdGVybGltaXQ9IjEwIiBwb2ludGVyLWV2ZW50cz0ic3Ryb2tlIi8+PHBhdGggZD0iTSAxMTc0LjI0IDgwLjc0IEwgMTE4OC4yNCA3My43NCBMIDExODguMjQgODcuNzQgWiIgZmlsbD0iIzk5OTk5OSIgc3Ryb2tlPSIjOTk5OTk5IiBzdHJva2Utd2lkdGg9IjIiIHN0cm9rZS1taXRlcmxpbWl0PSIxMCIgcG9pbnRlci1ldmVudHM9ImFsbCIvPjxyZWN0IHg9IjEyNTIiIHk9IjUwLjc0IiB3aWR0aD0iMTIwIiBoZWlnaHQ9IjYwIiByeD0iMzAiIHJ5PSIzMCIgZmlsbD0iIzM0NTI1MyIgc3Ryb2tlPSJub25lIiBwb2ludGVyLWV2ZW50cz0iYWxsIi8+PGcgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoLTAuNSAtMC41KXNjYWxlKDIpIj48c3dpdGNoPjxmb3JlaWduT2JqZWN0IHN0eWxlPSJvdmVyZmxvdzogdmlzaWJsZTsgdGV4dC1hbGlnbjogbGVmdDsiIHBvaW50ZXItZXZlbnRzPSJub25lIiB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiByZXF1aXJlZEZlYXR1cmVzPSJodHRwOi8vd3d3LnczLm9yZy9UUi9TVkcxMS9mZWF0dXJlI0V4dGVuc2liaWxpdHkiPjxkaXYgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkveGh0bWwiIHN0eWxlPSJkaXNwbGF5OiBmbGV4OyBhbGlnbi1pdGVtczogdW5zYWZlIGNlbnRlcjsganVzdGlmeS1jb250ZW50OiB1bnNhZmUgY2VudGVyOyB3aWR0aDogNThweDsgaGVpZ2h0OiAxcHg7IHBhZGRpbmctdG9wOiA0MHB4OyBtYXJnaW4tbGVmdDogNjI3cHg7Ij48ZGl2IHN0eWxlPSJib3gtc2l6aW5nOiBib3JkZXItYm94OyBmb250LXNpemU6IDA7IHRleHQtYWxpZ246IGNlbnRlcjsgIj48ZGl2IHN0eWxlPSJkaXNwbGF5OiBpbmxpbmUtYmxvY2s7IGZvbnQtc2l6ZTogMTJweDsgZm9udC1mYW1pbHk6IFRhaG9tYTsgY29sb3I6ICMzNDUyNTM7IGxpbmUtaGVpZ2h0OiAxLjI7IHBvaW50ZXItZXZlbnRzOiBhbGw7IHdoaXRlLXNwYWNlOiBub3JtYWw7IHdvcmQtd3JhcDogbm9ybWFsOyAiPjxmb250IGNvbG9yPSIjZmZmZmZmIiBmYWNlPSJIZWx2ZXRpY2EiIHN0eWxlPSJsaW5lLWhlaWdodDogMTAwJSI+ZGVwczwvZm9udD48L2Rpdj48L2Rpdj48L2Rpdj48L2ZvcmVpZ25PYmplY3Q+PHRleHQgeD0iNjU2IiB5PSI0NCIgZmlsbD0iIzM0NTI1MyIgZm9udC1mYW1pbHk9IlRhaG9tYSIgZm9udC1zaXplPSIxMnB4IiB0ZXh0LWFuY2hvcj0ibWlkZGxlIj5kZXBzPC90ZXh0Pjwvc3dpdGNoPjwvZz48cmVjdCB4PSIxMzkyIiB5PSI2MC43NCIgd2lkdGg9IjI4MCIgaGVpZ2h0PSI0MCIgZmlsbD0ibm9uZSIgc3Ryb2tlPSJub25lIiBwb2ludGVyLWV2ZW50cz0iYWxsIi8+PGcgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoLTAuNSAtMC41KXNjYWxlKDIpIj48c3dpdGNoPjxmb3JlaWduT2JqZWN0IHN0eWxlPSJvdmVyZmxvdzogdmlzaWJsZTsgdGV4dC1hbGlnbjogbGVmdDsiIHBvaW50ZXItZXZlbnRzPSJub25lIiB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiByZXF1aXJlZEZlYXR1cmVzPSJodHRwOi8vd3d3LnczLm9yZy9UUi9TVkcxMS9mZWF0dXJlI0V4dGVuc2liaWxpdHkiPjxkaXYgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkveGh0bWwiIHN0eWxlPSJkaXNwbGF5OiBmbGV4OyBhbGlnbi1pdGVtczogdW5zYWZlIGNlbnRlcjsganVzdGlmeS1jb250ZW50OiB1bnNhZmUgZmxleC1zdGFydDsgd2lkdGg6IDEzOHB4OyBoZWlnaHQ6IDFweDsgcGFkZGluZy10b3A6IDQwcHg7IG1hcmdpbi1sZWZ0OiA2OThweDsiPjxkaXYgc3R5bGU9ImJveC1zaXppbmc6IGJvcmRlci1ib3g7IGZvbnQtc2l6ZTogMDsgdGV4dC1hbGlnbjogbGVmdDsgIj48ZGl2IHN0eWxlPSJkaXNwbGF5OiBpbmxpbmUtYmxvY2s7IGZvbnQtc2l6ZTogMTJweDsgZm9udC1mYW1pbHk6IEhlbHZldGljYTsgY29sb3I6ICMwMDAwMDA7IGxpbmUtaGVpZ2h0OiAxLjI7IHBvaW50ZXItZXZlbnRzOiBhbGw7IGZvbnQtd2VpZ2h0OiBib2xkOyB3aGl0ZS1zcGFjZTogbm9ybWFsOyB3b3JkLXdyYXA6IG5vcm1hbDsgIj48Zm9udCBjb2xvcj0iIzM0NTI1MyI+TWFwUGFydGl0aW9uc1JERDwvZm9udD48L2Rpdj48L2Rpdj48L2Rpdj48L2ZvcmVpZ25PYmplY3Q+PHRleHQgeD0iNjk4IiB5PSI0NCIgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9IkhlbHZldGljYSIgZm9udC1zaXplPSIxMnB4IiBmb250LXdlaWdodD0iYm9sZCI+TWFwUGFydGl0aW9uc1JERDwvdGV4dD48L3N3aXRjaD48L2c+PHJlY3QgeD0iNzEyIiB5PSIzMC43NCIgd2lkdGg9IjQ2MCIgaGVpZ2h0PSIxMDAiIHJ4PSI1MCIgcnk9IjUwIiBmaWxsPSIjZWRmMmY0IiBzdHJva2U9Im5vbmUiIHBvaW50ZXItZXZlbnRzPSJhbGwiLz48cGF0aCBkPSJNIDczMiA4MC43NCBMIDY2OC4yNCA4MC43NCIgZmlsbD0ibm9uZSIgc3Ryb2tlPSIjOTk5OTk5IiBzdHJva2Utd2lkdGg9IjIiIHN0cm9rZS1taXRlcmxpbWl0PSIxMCIgcG9pbnRlci1ldmVudHM9InN0cm9rZSIvPjxwYXRoIGQ9Ik0gNjU0LjI0IDgwLjc0IEwgNjY4LjI0IDczLjc0IEwgNjY4LjI0IDg3Ljc0IFoiIGZpbGw9IiM5OTk5OTkiIHN0cm9rZT0iIzk5OTk5OSIgc3Ryb2tlLXdpZHRoPSIyIiBzdHJva2UtbWl0ZXJsaW1pdD0iMTAiIHBvaW50ZXItZXZlbnRzPSJhbGwiLz48cmVjdCB4PSI3MzIiIHk9IjUwLjc0IiB3aWR0aD0iMTIwIiBoZWlnaHQ9IjYwIiByeD0iMzAiIHJ5PSIzMCIgZmlsbD0iIzM0NTI1MyIgc3Ryb2tlPSJub25lIiBwb2ludGVyLWV2ZW50cz0iYWxsIi8+PGcgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoLTAuNSAtMC41KXNjYWxlKDIpIj48c3dpdGNoPjxmb3JlaWduT2JqZWN0IHN0eWxlPSJvdmVyZmxvdzogdmlzaWJsZTsgdGV4dC1hbGlnbjogbGVmdDsiIHBvaW50ZXItZXZlbnRzPSJub25lIiB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiByZXF1aXJlZEZlYXR1cmVzPSJodHRwOi8vd3d3LnczLm9yZy9UUi9TVkcxMS9mZWF0dXJlI0V4dGVuc2liaWxpdHkiPjxkaXYgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkveGh0bWwiIHN0eWxlPSJkaXNwbGF5OiBmbGV4OyBhbGlnbi1pdGVtczogdW5zYWZlIGNlbnRlcjsganVzdGlmeS1jb250ZW50OiB1bnNhZmUgY2VudGVyOyB3aWR0aDogNThweDsgaGVpZ2h0OiAxcHg7IHBhZGRpbmctdG9wOiA0MHB4OyBtYXJnaW4tbGVmdDogMzY3cHg7Ij48ZGl2IHN0eWxlPSJib3gtc2l6aW5nOiBib3JkZXItYm94OyBmb250LXNpemU6IDA7IHRleHQtYWxpZ246IGNlbnRlcjsgIj48ZGl2IHN0eWxlPSJkaXNwbGF5OiBpbmxpbmUtYmxvY2s7IGZvbnQtc2l6ZTogMTJweDsgZm9udC1mYW1pbHk6IFRhaG9tYTsgY29sb3I6ICMzNDUyNTM7IGxpbmUtaGVpZ2h0OiAxLjI7IHBvaW50ZXItZXZlbnRzOiBhbGw7IHdoaXRlLXNwYWNlOiBub3JtYWw7IHdvcmQtd3JhcDogbm9ybWFsOyAiPjxmb250IGNvbG9yPSIjZmZmZmZmIiBmYWNlPSJIZWx2ZXRpY2EiPnJkZDwvZm9udD48L2Rpdj48L2Rpdj48L2Rpdj48L2ZvcmVpZ25PYmplY3Q+PHRleHQgeD0iMzk2IiB5PSI0NCIgZmlsbD0iIzM0NTI1MyIgZm9udC1mYW1pbHk9IlRhaG9tYSIgZm9udC1zaXplPSIxMnB4IiB0ZXh0LWFuY2hvcj0ibWlkZGxlIj5yZGQ8L3RleHQ+PC9zd2l0Y2g+PC9nPjxyZWN0IHg9Ijg3MiIgeT0iNjAuNzQiIHdpZHRoPSIyODAiIGhlaWdodD0iNDAiIGZpbGw9Im5vbmUiIHN0cm9rZT0ibm9uZSIgcG9pbnRlci1ldmVudHM9ImFsbCIvPjxnIHRyYW5zZm9ybT0idHJhbnNsYXRlKC0wLjUgLTAuNSlzY2FsZSgyKSI+PHN3aXRjaD48Zm9yZWlnbk9iamVjdCBzdHlsZT0ib3ZlcmZsb3c6IHZpc2libGU7IHRleHQtYWxpZ246IGxlZnQ7IiBwb2ludGVyLWV2ZW50cz0ibm9uZSIgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgcmVxdWlyZWRGZWF0dXJlcz0iaHR0cDovL3d3dy53My5vcmcvVFIvU1ZHMTEvZmVhdHVyZSNFeHRlbnNpYmlsaXR5Ij48ZGl2IHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hodG1sIiBzdHlsZT0iZGlzcGxheTogZmxleDsgYWxpZ24taXRlbXM6IHVuc2FmZSBjZW50ZXI7IGp1c3RpZnktY29udGVudDogdW5zYWZlIGZsZXgtc3RhcnQ7IHdpZHRoOiAxMzhweDsgaGVpZ2h0OiAxcHg7IHBhZGRpbmctdG9wOiA0MHB4OyBtYXJnaW4tbGVmdDogNDM4cHg7Ij48ZGl2IHN0eWxlPSJib3gtc2l6aW5nOiBib3JkZXItYm94OyBmb250LXNpemU6IDA7IHRleHQtYWxpZ246IGxlZnQ7ICI+PGRpdiBzdHlsZT0iZGlzcGxheTogaW5saW5lLWJsb2NrOyBmb250LXNpemU6IDEycHg7IGZvbnQtZmFtaWx5OiBIZWx2ZXRpY2E7IGNvbG9yOiAjMDAwMDAwOyBsaW5lLWhlaWdodDogMS4yOyBwb2ludGVyLWV2ZW50czogYWxsOyBmb250LXdlaWdodDogYm9sZDsgd2hpdGUtc3BhY2U6IG5vcm1hbDsgd29yZC13cmFwOiBub3JtYWw7ICI+PHNwYW4gc3R5bGU9ImNvbG9yOiByZ2IoNTIgLCA4MiAsIDgzKSI+T25lVG9PbmVEZXBlbmRlbmN5PC9zcGFuPjwvZGl2PjwvZGl2PjwvZGl2PjwvZm9yZWlnbk9iamVjdD48dGV4dCB4PSI0MzgiIHk9IjQ0IiBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0iSGVsdmV0aWNhIiBmb250LXNpemU9IjEycHgiIGZvbnQtd2VpZ2h0PSJib2xkIj5PbmVUb09uZURlcGVuZGVuY3k8L3RleHQ+PC9zd2l0Y2g+PC9nPjxyZWN0IHg9IjE5MiIgeT0iMzAuNzQiIHdpZHRoPSI0NjAiIGhlaWdodD0iMTAwIiByeD0iNTAiIHJ5PSI1MCIgZmlsbD0iI2VkZjJmNCIgc3Ryb2tlPSJub25lIiBwb2ludGVyLWV2ZW50cz0iYWxsIi8+PHBhdGggZD0iTSAyMTIgODAuNzQgTCAxNDguMjQgODAuNzQiIGZpbGw9Im5vbmUiIHN0cm9rZT0iIzk5OTk5OSIgc3Ryb2tlLXdpZHRoPSIyIiBzdHJva2UtbWl0ZXJsaW1pdD0iMTAiIHBvaW50ZXItZXZlbnRzPSJzdHJva2UiLz48cGF0aCBkPSJNIDEzNC4yNCA4MC43NCBMIDE0OC4yNCA3My43NCBMIDE0OC4yNCA4Ny43NCBaIiBmaWxsPSIjOTk5OTk5IiBzdHJva2U9IiM5OTk5OTkiIHN0cm9rZS13aWR0aD0iMiIgc3Ryb2tlLW1pdGVybGltaXQ9IjEwIiBwb2ludGVyLWV2ZW50cz0iYWxsIi8+PHJlY3QgeD0iMjEyIiB5PSI1MC43NCIgd2lkdGg9IjEyMCIgaGVpZ2h0PSI2MCIgcng9IjMwIiByeT0iMzAiIGZpbGw9IiMzNDUyNTMiIHN0cm9rZT0ibm9uZSIgcG9pbnRlci1ldmVudHM9ImFsbCIvPjxnIHRyYW5zZm9ybT0idHJhbnNsYXRlKC0wLjUgLTAuNSlzY2FsZSgyKSI+PHN3aXRjaD48Zm9yZWlnbk9iamVjdCBzdHlsZT0ib3ZlcmZsb3c6IHZpc2libGU7IHRleHQtYWxpZ246IGxlZnQ7IiBwb2ludGVyLWV2ZW50cz0ibm9uZSIgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgcmVxdWlyZWRGZWF0dXJlcz0iaHR0cDovL3d3dy53My5vcmcvVFIvU1ZHMTEvZmVhdHVyZSNFeHRlbnNpYmlsaXR5Ij48ZGl2IHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hodG1sIiBzdHlsZT0iZGlzcGxheTogZmxleDsgYWxpZ24taXRlbXM6IHVuc2FmZSBjZW50ZXI7IGp1c3RpZnktY29udGVudDogdW5zYWZlIGNlbnRlcjsgd2lkdGg6IDU4cHg7IGhlaWdodDogMXB4OyBwYWRkaW5nLXRvcDogNDBweDsgbWFyZ2luLWxlZnQ6IDEwN3B4OyI+PGRpdiBzdHlsZT0iYm94LXNpemluZzogYm9yZGVyLWJveDsgZm9udC1zaXplOiAwOyB0ZXh0LWFsaWduOiBjZW50ZXI7ICI+PGRpdiBzdHlsZT0iZGlzcGxheTogaW5saW5lLWJsb2NrOyBmb250LXNpemU6IDEycHg7IGZvbnQtZmFtaWx5OiBUYWhvbWE7IGNvbG9yOiAjMzQ1MjUzOyBsaW5lLWhlaWdodDogMS4yOyBwb2ludGVyLWV2ZW50czogYWxsOyB3aGl0ZS1zcGFjZTogbm9ybWFsOyB3b3JkLXdyYXA6IG5vcm1hbDsgIj48Zm9udCBjb2xvcj0iI2ZmZmZmZiIgZmFjZT0iSGVsdmV0aWNhIiBzdHlsZT0ibGluZS1oZWlnaHQ6IDEwMCUiPmRlcHM8L2ZvbnQ+PC9kaXY+PC9kaXY+PC9kaXY+PC9mb3JlaWduT2JqZWN0Pjx0ZXh0IHg9IjEzNiIgeT0iNDQiIGZpbGw9IiMzNDUyNTMiIGZvbnQtZmFtaWx5PSJUYWhvbWEiIGZvbnQtc2l6ZT0iMTJweCIgdGV4dC1hbmNob3I9Im1pZGRsZSI+ZGVwczwvdGV4dD48L3N3aXRjaD48L2c+PHJlY3QgeD0iMzUyIiB5PSI2MC43NCIgd2lkdGg9IjI4MCIgaGVpZ2h0PSI0MCIgZmlsbD0ibm9uZSIgc3Ryb2tlPSJub25lIiBwb2ludGVyLWV2ZW50cz0iYWxsIi8+PGcgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoLTAuNSAtMC41KXNjYWxlKDIpIj48c3dpdGNoPjxmb3JlaWduT2JqZWN0IHN0eWxlPSJvdmVyZmxvdzogdmlzaWJsZTsgdGV4dC1hbGlnbjogbGVmdDsiIHBvaW50ZXItZXZlbnRzPSJub25lIiB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiByZXF1aXJlZEZlYXR1cmVzPSJodHRwOi8vd3d3LnczLm9yZy9UUi9TVkcxMS9mZWF0dXJlI0V4dGVuc2liaWxpdHkiPjxkaXYgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkveGh0bWwiIHN0eWxlPSJkaXNwbGF5OiBmbGV4OyBhbGlnbi1pdGVtczogdW5zYWZlIGNlbnRlcjsganVzdGlmeS1jb250ZW50OiB1bnNhZmUgZmxleC1zdGFydDsgd2lkdGg6IDEzOHB4OyBoZWlnaHQ6IDFweDsgcGFkZGluZy10b3A6IDQwcHg7IG1hcmdpbi1sZWZ0OiAxNzhweDsiPjxkaXYgc3R5bGU9ImJveC1zaXppbmc6IGJvcmRlci1ib3g7IGZvbnQtc2l6ZTogMDsgdGV4dC1hbGlnbjogbGVmdDsgIj48ZGl2IHN0eWxlPSJkaXNwbGF5OiBpbmxpbmUtYmxvY2s7IGZvbnQtc2l6ZTogMTJweDsgZm9udC1mYW1pbHk6IEhlbHZldGljYTsgY29sb3I6ICMwMDAwMDA7IGxpbmUtaGVpZ2h0OiAxLjI7IHBvaW50ZXItZXZlbnRzOiBhbGw7IGZvbnQtd2VpZ2h0OiBib2xkOyB3aGl0ZS1zcGFjZTogbm9ybWFsOyB3b3JkLXdyYXA6IG5vcm1hbDsgIj48c3BhbiBzdHlsZT0iY29sb3I6IHJnYig1MiAsIDgyICwgODMpIDsgdGV4dC1hbGlnbjogY2VudGVyIj5IYWRvb3BSREQ8L3NwYW4+PC9kaXY+PC9kaXY+PC9kaXY+PC9mb3JlaWduT2JqZWN0Pjx0ZXh0IHg9IjE3OCIgeT0iNDQiIGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJIZWx2ZXRpY2EiIGZvbnQtc2l6ZT0iMTJweCIgZm9udC13ZWlnaHQ9ImJvbGQiPkhhZG9vcFJERDwvdGV4dD48L3N3aXRjaD48L2c+PHJlY3QgeD0iMzIiIHk9IjMwLjc0IiB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgcng9IjUwIiByeT0iNTAiIGZpbGw9IiNlZGYyZjQiIHN0cm9rZT0ibm9uZSIgcG9pbnRlci1ldmVudHM9ImFsbCIvPjxnIHRyYW5zZm9ybT0idHJhbnNsYXRlKC0wLjUgLTAuNSlzY2FsZSgyKSI+PHN3aXRjaD48Zm9yZWlnbk9iamVjdCBzdHlsZT0ib3ZlcmZsb3c6IHZpc2libGU7IHRleHQtYWxpZ246IGxlZnQ7IiBwb2ludGVyLWV2ZW50cz0ibm9uZSIgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgcmVxdWlyZWRGZWF0dXJlcz0iaHR0cDovL3d3dy53My5vcmcvVFIvU1ZHMTEvZmVhdHVyZSNFeHRlbnNpYmlsaXR5Ij48ZGl2IHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hodG1sIiBzdHlsZT0iZGlzcGxheTogZmxleDsgYWxpZ24taXRlbXM6IHVuc2FmZSBjZW50ZXI7IGp1c3RpZnktY29udGVudDogdW5zYWZlIGNlbnRlcjsgd2lkdGg6IDQ4cHg7IGhlaWdodDogMXB4OyBwYWRkaW5nLXRvcDogNDBweDsgbWFyZ2luLWxlZnQ6IDE3cHg7Ij48ZGl2IHN0eWxlPSJib3gtc2l6aW5nOiBib3JkZXItYm94OyBmb250LXNpemU6IDA7IHRleHQtYWxpZ246IGNlbnRlcjsgIj48ZGl2IHN0eWxlPSJkaXNwbGF5OiBpbmxpbmUtYmxvY2s7IGZvbnQtc2l6ZTogMTJweDsgZm9udC1mYW1pbHk6IFRhaG9tYTsgY29sb3I6ICMzNDUyNTM7IGxpbmUtaGVpZ2h0OiAxLjI7IHBvaW50ZXItZXZlbnRzOiBhbGw7IHdoaXRlLXNwYWNlOiBub3JtYWw7IHdvcmQtd3JhcDogbm9ybWFsOyAiPjxiPjxpPk5pbDwvaT48L2I+PC9kaXY+PC9kaXY+PC9kaXY+PC9mb3JlaWduT2JqZWN0Pjx0ZXh0IHg9IjQxIiB5PSI0NCIgZmlsbD0iIzM0NTI1MyIgZm9udC1mYW1pbHk9IlRhaG9tYSIgZm9udC1zaXplPSIxMnB4IiB0ZXh0LWFuY2hvcj0ibWlkZGxlIj5OaWw8L3RleHQ+PC9zd2l0Y2g+PC9nPjwvZz48c3dpdGNoPjxnIHJlcXVpcmVkRmVhdHVyZXM9Imh0dHA6Ly93d3cudzMub3JnL1RSL1NWRzExL2ZlYXR1cmUjRXh0ZW5zaWJpbGl0eSIvPjxhIHRyYW5zZm9ybT0idHJhbnNsYXRlKDAsLTUpIiB4bGluazpocmVmPSJodHRwczovL3d3dy5kaWFncmFtcy5uZXQvZG9jL2ZhcS9zdmctZXhwb3J0LXRleHQtcHJvYmxlbXMiIHRhcmdldD0iX2JsYW5rIj48dGV4dCB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmb250LXNpemU9IjEwcHgiIHg9IjUwJSIgeT0iMTAwJSI+Vmlld2VyIGRvZXMgbm90IHN1cHBvcnQgZnVsbCBTVkcgMS4xPC90ZXh0PjwvYT48L3N3aXRjaD48L3N2Zz4=" width="1725" height="164" class="img_ev3q"></p><p>当然，同 RDD 一样，RDD 的 Dependency 也有多种实现，其类型和产生过程也会根据 RDD 实现类的不同而不同。但大体上，可分为两类：<strong>宽依赖（Wide Dependency）</strong>与<strong> 窄依赖（Narrow Dependency）</strong>。</p><div class="theme-admonition theme-admonition-info alert alert--info admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_S0QG"><p>掌握宽窄依赖，是后续学习 RDD 阶段划分的基础，而 RDD 阶段划分，又是学习 Spark 任务划分的前提。这一系列知识，将有助于我们了解一个计算应用在提交后的执行过程。 </p></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="窄依赖">窄依赖<a class="hash-link" href="#窄依赖" title="Direct link to heading">​</a></h3><p>窄依赖存在两种实现类，分别是 <strong>OneToOneDependency</strong>和 <strong>RangeDependency</strong>，它主要表现为 <strong>父 RDD 的每个分区最多被子 RDD 的一个分区所使用</strong>。</p><p>窄依赖通常存在于 <code>map</code>、<code>filter</code>、<code>union</code> 等转换操作中，这些转换操作的共同点为 <strong>一个输入分区对应于一个输出分区</strong>，如下图所示：</p><p><img loading="lazy" src="/assets/images/narrow-c10c7926e6332e3901a31171ba39fccb.svg" width="1770" height="1113" class="img_ev3q"></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="宽依赖">宽依赖<a class="hash-link" href="#宽依赖" title="Direct link to heading">​</a></h3><p>宽依赖仅有 <strong>ShuffleDependency </strong>一个实现类，它主要表现为 <strong>父 RDD 的每个分区对应子 RDD 的多个分区</strong>。</p><p>宽依赖通常发生在 <code>groupByKey</code>、<code>reduceByKey</code> 等转换操作中，这些转换操作通常会导致 shuffle 的发生，如下图：</p><p><img loading="lazy" src="/assets/images/wide-25b96fe616041692d8e550a342a183d0.svg" width="1830" height="703" class="img_ev3q"></p><p>与窄依赖不同，ShuffleDependency 中包含着大量的信息，其主要变量如下所示：</p><ul><li><code>_rdd</code>：指向父 RDD</li><li><code>partitioner</code>：shuffle 过程中决定数据输出分区的分区器</li><li><code>serializer</code>：序列化器，可由配置 <code>spark.serializer</code> 指定</li><li><code>keyOrdering</code>：指定 shuffle 过程中 key 的排序规则，若为空，默认使用 hash 排序</li><li><code>aggregator</code>：指定 shuffle 过程中的聚合器</li><li><code>mapSideCombine</code>：是否需要 map 端聚合，若是，<code>aggregator</code> 必须有值</li><li><code>shuffleWriterProcessor</code>：ShuffleMapTask 中用于控制写出行为的处理器</li><li><code>shuffleId</code>：shuffle 的原子性计数，由 <code>0</code> 开始递增</li><li><code>shuffleHandle</code>：用于决定 shuffle write 类型的对象</li></ul><p><strong>ShuffleDependency 的这些变量主要用于 shuffle write 和 shuffle read 过程中的信息传递。</strong>对于初学者来说，想直接理解透 ShuffleDependency 显然是不现实的，笔者建议在大致了解了 shuffle 的过程后再回过头来细看这部分内容。</p><div class="theme-admonition theme-admonition-caution alert alert--warning admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>caution</div><div class="admonitionContent_S0QG"><p>在 ShuffleDependency 中，<code>_rdd</code> 使用了关键字 <code>transient</code> 进行修饰。 这是因为，在 Executor 端，并不需要 <code>_rdd</code> 的信息，使用 <code>transient</code> 修饰可以减少网络传输中的序列化工作。</p></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="rdd-血缘关系">RDD 血缘关系<a class="hash-link" href="#rdd-血缘关系" title="Direct link to heading">​</a></h2><p>血缘关系是 RDD 的重要特性之一，基于 RDD 核心属性 <code>dependencies</code> 实现，它描述了一个 RDD 是如何从初始 RDD 计算得来的。</p><p>我们可以通过 <code>toDebugString()</code> 方法打印出这个信息，例如：</p><div class="language-纯文本 codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-纯文本 codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">(3) MapPartitionsRDD[2] at flatMap at WordCount.scala:21 []</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> |  data/* MapPartitionsRDD[1] at textFile at WordCount.scala:15 []</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> |  data/* HadoopRDD[0] at textFile at WordCount.scala:15 []</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>我们也可以通过图例来直观地认识血缘关系：</p><p><img loading="lazy" src="/assets/images/lineage-5e980c3ac6ec7d1daa2802cf7d23efd6.svg" width="1245" height="255" class="img_ev3q"></p><p>图例展现了一个 Spark 应用从输入到输出的过程。在该过程中，存在着一系列 RDD 的创建与转换，Spark 会记录转换过程中各个 RDD 的依赖关系，并在 RDD F 调用行动算子后构建 DAG 图，触发真正的计算。</p><p>将上述过程中 RDD 的依赖关系串联起来，便形成一个血缘关系（Lineage）。在血缘关系中，下一代的 RDD 依赖于上一代的 RDD。以图例说明，B 依赖于 A，D 依赖于 C，E 依赖于 B 和 D。</p><div class="theme-admonition theme-admonition-info alert alert--info admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_S0QG"><p>血缘关系的存在使 RDD 具备了容错性。当 RDD 的部分分区数据丢失时，Spark 可以通过血缘关系获取足够的关联信息，进而重新计算并恢复丢失的分区。</p></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="rdd-持久化">RDD 持久化<a class="hash-link" href="#rdd-持久化" title="Direct link to heading">​</a></h2><p>RDD 持久化是 Spark 中一个很重要的特性。通过这个特性，Spark 可以在内存或磁盘缓存某个 RDD，当其他行动算子需要这个 RDD 时直接复用它，以 <strong>避免重新计算</strong>，进而提高性能。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="图解说明">图解说明<a class="hash-link" href="#图解说明" title="Direct link to heading">​</a></h3><p>我们通过一个例子对 RDD 持久化展开说明：</p><p><img loading="lazy" src="/assets/images/persist-614a0394c044daea0faf90a3a13cd164.svg" width="1422" height="414" class="img_ev3q"></p><p>假设某个计算任务有 3 个阶段：</p><ul><li>STEP 01 从 HDFS 读取文件并创建 RDD A</li><li>STEP 02 通过转换算子基于 RDD A 生成 RDD B</li><li>STEP 03 通过行动算子基于 RDD B 输出两个结果</li></ul><p>如果没有缓存机制，STEP 03 将会触发两次完整的计算，即 STEP 01 → STEP 02 → STEP 03 将完整执行两次。</p><p>如果使用了缓存机制，STEP 03 在输出 result2 时，将直接复用 result1 中已缓存的 RDD B，RDD B 之前的计算环节不会被重新执行。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="复用原理">复用原理<a class="hash-link" href="#复用原理" title="Direct link to heading">​</a></h3><p>图解部分我们提到，当使用缓存机制时，RDD B 的计算结果会被直接复用，其计算环节不会被重新执行。那么，这个“不会被重新执行”应该如何理解？这里列举两种常见思路：</p><ul><li>基于 RDD B 拆解出的计算任务不会被调度，自然不会重复计算</li><li>基于 RDD B 拆解出的计算任务会被调度，但是计算过程中会直接读取缓存的值，不会重复计算</li></ul><p>为了解决这个问题，我们可以先尝试从输出日志寻找答案。</p><p>以下为未使用缓存机制时的日志片段：</p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Starting task 0.0 in stage 2.0 (TID 6) (10.6.30.80, executor driver, partition 0, PROCESS_LOCAL, 4504 bytes) taskResourceAssignments Map()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Running task 0.0 in stage 2.0 (TID 6)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">**Input split: file:/E:/project/scala/spark-study/data/wc.txt:0+26**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Finished task 0.0 in stage 2.0 (TID 6). 1204 bytes result sent to driver</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>以下为使用缓存机制时的日志片段：</p><div class="language-纯文本 codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-纯文本 codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Starting task 0.0 in stage 2.0 (TID 6) (10.6.30.80, executor driver, partition 0, PROCESS_LOCAL, 4504 bytes) taskResourceAssignments Map()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Running task 0.0 in stage 2.0 (TID 6)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">**Found block rdd_3_0 locally**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Finished task 0.0 in stage 2.0 (TID 6). 1204 bytes result sent to driver</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>通过日志片段，可以确认两个关键信息：</p><ul><li>无论缓存是否开启，基于 RDD B 拆解出的计算任务都会被重复调度</li><li>基于 RDD B 拆解出的计算任务在重复发布到 Executor 执行时，会直接读取缓存中的计算结果，不会触发实际的计算</li></ul><p>为了验证第二点的正确性，我们跟踪了 Executor 端执行任务的源码，具体过程如下图所示：</p><p><img loading="lazy" src="/assets/images/cache-be38ab2de169825ffe55789741ba645b.svg" width="2142" height="1043" class="img_ev3q"></p><p>其中 <strong>步骤 4</strong> 的 BlockResult 便是我们想要的缓存结果。若 BlockResult 有值，直接返回给 Executor，不再触发计算；若 BlockResult 为空，则需要执行计算再返回结果。具体的实现源码如下：</p><div class="language-scala codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-scala codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> getOrElseUpdate</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">T</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    blockId</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> BlockId</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    level</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> StorageLevel</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    classTag</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> ClassTag</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">T</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    makeIterator</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">=&gt;</span><span class="token plain"> Iterator</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">T</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Either</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">BlockResult</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> Iterator</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">T</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// Attempt to read the block from local or remote storage. If it&#x27;s present, then we don&#x27;t need</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// to go through the local-get-or-put path.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  get</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">T</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">blockId</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">classTag</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">match</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> Some</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">block</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">=&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> Left</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">block</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> _ </span><span class="token keyword" style="color:#00009f">=&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic">// Need to compute the block.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> get</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">T</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> ClassTag</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">blockId</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> BlockId</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Option</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">BlockResult</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">val</span><span class="token plain"> local </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> getLocalValues</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">blockId</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">local</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">isDefined</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    logInfo</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string-interpolation id function" style="color:#d73a49">s</span><span class="token string-interpolation string" style="color:#e3116c">&quot;Found block </span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">$</span><span class="token string-interpolation interpolation expression">blockId</span><span class="token string-interpolation string" style="color:#e3116c"> locally&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> local</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">val</span><span class="token plain"> remote </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> getRemoteValues</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">T</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">blockId</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">remote</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">isDefined</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    logInfo</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string-interpolation id function" style="color:#d73a49">s</span><span class="token string-interpolation string" style="color:#e3116c">&quot;Found block </span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">$</span><span class="token string-interpolation interpolation expression">blockId</span><span class="token string-interpolation string" style="color:#e3116c"> remotely&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> remote</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  None</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="存储级别">存储级别<a class="hash-link" href="#存储级别" title="Direct link to heading">​</a></h3><p>在代码中，我们可以使用 <code>cache()</code> 方法或者 <code>persist()</code> 方法来指定持久化。其中，<code>persist()</code> 方法存在一个名为 <strong>存储级别</strong> 的参数，该参数将决定 RDD 持久化具体的存储位置与存储行为。</p><div class="theme-admonition theme-admonition-info alert alert--info admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_S0QG"><p><code>cache()</code> 实际上调用的是 <code>persist(StorageLevel.MEMORY_ONLY)</code> 方法，即基于内存缓存 RDD。</p></div></div><p>目前，RDD 已支持的存储级别如下表所示：</p><table><thead><tr><th><strong>持久化级别</strong></th><th><strong>含义</strong></th></tr></thead><tbody><tr><td>MEMORY_ONLY</td><td>将 RDD 以反序列化 Java 对象的形式存储在 JVM 中，如果大小超过可用内存，则超出部分不会缓存，需重新计算</td></tr><tr><td>MEMORY_AND_DISK</td><td>将 RDD 以反序列化 Java 对象的形式存储在 JVM 中，如果大小超过可用内存，则超出部分会存在在磁盘上，当需要时从磁盘读取</td></tr><tr><td>DISK_ONLY</td><td>将所有 RDD 分区存储到磁盘上</td></tr><tr><td>MEMORY_ONLY_SER</td><td>将 RDD 以序列化 Java 对象的形式存储在 JVM 中，具有更好的空间利用率，但是需要占用更多的 CPU 资源</td></tr><tr><td>MEMORY_AND_DISK_SER</td><td>将 RDD 以序列化 Java 对象的形式存储在 JVM 中，如果大小超过可用内存，则超出部分会存在在磁盘上，无需重新计算</td></tr><tr><td>MEMORY_ONLY_2</td><td>与 MEMORY_ONLY 级别相同，存在副本</td></tr><tr><td>MEMORY_AND_DISK_2</td><td>与 MEMORY_AND_DISK 级别相同，存在副本</td></tr></tbody></table><p>对于存储级别的选择，官方给出了以下建议：</p><hr><p><strong>Tip 01</strong> 如果 RDD 与默认存储级别 <code>MEMORY_ONLY</code> 契合，就选择默认存储级别。</p><p><strong>Tip 02</strong> 如果 RDD 与默认存储级别 <code>MEMORY_ONLY</code> 不契合，则尝试使用 <code>MEMORY_ONLY_SER</code> 并选择一个合适的序列化库，这支持 Spark 在具备较高空间利用率的情况下依旧支持快速访问。</p><p><strong>Tip 03</strong> 尽量不要将缓存数据写到磁盘上，除非数据量特别大或者需要过滤大量数据，因为重新计算的速度与从硬盘读取数据的速度相差不多。</p><p><strong>Tip 04 </strong> 如果想要具备故障快速恢复能力，可以选择带有副本的存储级别。当然，没有副本的存储级别并非是不安全的，它们同样具备容错机制，只是在故障恢复时需要重新计算，无法像带有副本的存储级别那样直接通过副本恢复。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="rdd-检查点">RDD 检查点<a class="hash-link" href="#rdd-检查点" title="Direct link to heading">​</a></h2><p>检查点是 RDD 的一种容错保障机制，由 RDD 的 <code>checkpoint()</code> 方法触发。它主要做了两件事：</p><ul><li>重新计算调用了 <code>checkpoint()</code> 方法的 RDD，并将计算结果保存至外部存储（本地文件系统、分布式文件系统等）</li><li>切断原有的血缘关系</li></ul><p>乍看之下，会觉得检查点与持久化非常相似，都有保存 RDD 计算结果的功能，但实际上两者还是有所区别的：</p><table><thead><tr><th>区别项</th><th>RDD 持久化</th><th>RDD 检查点</th></tr></thead><tbody><tr><td>生命周期</td><td>应用结束便删除</td><td>永久保存</td></tr><tr><td>血缘关系</td><td>不切断</td><td>切断</td></tr><tr><td>使用场景</td><td>支持在同一个应用中复用计算结果</td><td>支持在多个应用中复用计算结果</td></tr></tbody></table><h3 class="anchor anchorWithStickyNavbar_LWe7" id="实现原理">实现原理<a class="hash-link" href="#实现原理" title="Direct link to heading">​</a></h3><p>RDD 检查点的实现方式比较特别，当我们调用 <code>checkpoint()</code> 方法时，RDD 只是将自身标记为检查状态，并不会马上触发检查点存储，具体如代码所示：</p><div class="language-scala codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-scala codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"> * Mark this RDD for checkpointing. It will be saved to a file inside the checkpoint</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"> * directory set with `SparkContext#setCheckpointDir` and all references to its parent</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"> * RDDs will be removed. **This function must be called before any job has been</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"> * executed on this RDD. **It is strongly recommended that this RDD is persisted in</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"> * memory, otherwise saving it on a file will require recomputation.</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"> */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> checkpoint</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">Unit</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> RDDCheckpointData</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">synchronized </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">context</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">checkpointDir</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">isEmpty</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">throw</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> SparkException</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;Checkpoint directory has not been set in the SparkContext&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">checkpointData</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">isEmpty</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    checkpointData </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Some</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> ReliableRDDCheckpointData</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>那么，RDD 的检查点机制究竟是怎样的一个过程呢？我们在方法注释中注意到一个关键信息：<code>This function must be called before any job has been * executed on this RDD</code>。这表明，<code>checkpoint()</code> 需要在计算作业开始执行前（即行动算子触发前）调用。基于此，我们有足够的理由猜测检查点机制与行动算子的触发有关。在逐步深入行动算子的源码后，我们最终在 SparkContext 的 <code>runJob</code> 方法中发现了检查点机制的身影：</p><div class="language-scala codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-scala codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> runJob</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">T</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> U</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> ClassTag</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    rdd</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> RDD</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">T</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    func</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">TaskContext</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> Iterator</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">T</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">=&gt;</span><span class="token plain"> U</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    partitions</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Seq</span><span class="token punctuation" style="color:#393A34">[</span><span class="token builtin">Int</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    resultHandler</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token builtin">Int</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> U</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">=&gt;</span><span class="token plain"> </span><span class="token builtin">Unit</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">Unit</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  dagScheduler</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">runJob</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">rdd</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> cleanedFunc</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> partitions</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> callSite</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> resultHandler</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> localProperties</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  progressBar</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">foreach</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">_</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">finishAll</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">*</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">rdd</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">doCheckpoint</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">*</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>其中，<code>dagScheduler.runJob</code> 便是计算作业的执行入口，而 RDD 的 <code>doCheckpoint()</code> 方法在其之后调用便可证明一个结论：<strong>RDD 的检查点机制与计算作业并非同步执行，它是在计算作业执行结束后触发的。</strong></p><p>至此，我们已经知晓了检查点机制的触发时机，但仍旧有一个问题：检查点机制是如何保存计算结果的？</p><p>为解决这个问题，我们继续深入 <code>doCheckpoint()</code> 的源码，最终得到了如下的方法调用链：</p><p><img loading="lazy" src="/assets/images/checkpoint-3600f69c6aaaa8bbf94c2dd7990890be.svg" width="2142" height="843" class="img_ev3q"></p><p>图中的 <strong>步骤 4</strong> 表明，<strong>检查点机制本质上就是再执行一遍 RDD 的计算逻辑，然后将计算结果保存至外部存储。</strong></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="使用示例">使用示例<a class="hash-link" href="#使用示例" title="Direct link to heading">​</a></h3><p>RDD 检查点机制的使用主要包含了两个阶段：</p><ul><li>写出阶段（RDD 计算结果的保存）</li><li>读取阶段（RDD 计算结果的读取）</li></ul><p>以下为存储阶段的代码示例：</p><div class="language-scala codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-scala codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">sc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">setCheckpointDir</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;checkpoint&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rdd</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">cache</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rdd</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">checkpoint</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// action</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="theme-admonition theme-admonition-info alert alert--info admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_S0QG"><p><code>setCheckpointDir</code> 方法参数中的目录地址可以是本地地址也可以是分布式文件系统的地址。</p></div></div><div class="theme-admonition theme-admonition-caution alert alert--warning admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>caution</div><div class="admonitionContent_S0QG"><p>官方建议，使用 <code>checkpoint()</code> 前最好通过 <code>cache()</code> 缓存计算结果，以避免检查点存储快照时发生重复计算。</p></div></div><p>当我们需要复用之前的计算结果时，可以把检查点保存路径当作数据源来读取 <code>rdd</code> 的计算结果：</p><div class="language-scala codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-scala codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">object</span><span class="token plain"> CheckpointReadApp </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> main</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">args</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Array</span><span class="token punctuation" style="color:#393A34">[</span><span class="token builtin">String</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">Unit</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">val</span><span class="token plain"> conf</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> SparkConf </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> SparkConf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">setMaster</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;local&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">setAppName</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;Checkpoint Read App&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">val</span><span class="token plain"> sc</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> SparkContext </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> SparkContext</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">conf</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">val</span><span class="token plain"> wordMap</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> RDD</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">(</span><span class="token builtin">String</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token builtin">Int</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      CheckpointRecover</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">recover</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">sc</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;E:\\project\\scala\\spark-study\\checkpoint\\4c2a4f90-acbd-4c66-a956-1221d57e8472\\rdd-3&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">val</span><span class="token plain"> results</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> RDD</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">(</span><span class="token builtin">String</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token builtin">Int</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> wordMap</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">reduceByKey</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">_ </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> _</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    results</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">collect</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">foreach</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">result </span><span class="token keyword" style="color:#00009f">=&gt;</span><span class="token plain"> println</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">result</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">object</span><span class="token plain"> CheckpointRecover </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> recover</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">T</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> ClassTag</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">sc</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> SparkContext</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> path</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">String</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> RDD</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">T</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    sc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">checkpointFile</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">T</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">path</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="theme-admonition theme-admonition-danger alert alert--danger admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M5.05.31c.81 2.17.41 3.38-.52 4.31C3.55 5.67 1.98 6.45.9 7.98c-1.45 2.05-1.7 6.53 3.53 7.7-2.2-1.16-2.67-4.52-.3-6.61-.61 2.03.53 3.33 1.94 2.86 1.39-.47 2.3.53 2.27 1.67-.02.78-.31 1.44-1.13 1.81 3.42-.59 4.78-3.42 4.78-5.56 0-2.84-2.53-3.22-1.25-5.61-1.52.13-2.03 1.13-1.89 2.75.09 1.08-1.02 1.8-1.86 1.33-.67-.41-.66-1.19-.06-1.78C8.18 5.31 8.68 2.45 5.05.32L5.03.3l.02.01z"></path></svg></span>danger</div><div class="admonitionContent_S0QG"><p>因为 SparkContext 中的 <code>checkpointFile</code> 方法是 <code>protected</code> 级别的，所以示例中的 CheckpointRecover 需要创建在包路径 <code>org.apache.spark</code> 下。</p></div></div><p>通过最终的计算结果可以看出，检查点机制确实可以帮助我们保存之前的中间结果，并在之后的作业中复用它，以避免重复计算的发生，进而节约计算资源。</p><p>这样看来，检查点机制好像是一个非常好的特性，但实际工作中，还需要考虑到：</p><ul><li>检查点的保存需要占用存储资源</li><li>检查点写出时需要重复调度计算任务，尽管可以事先使用 <code>cache()</code> 规避重复计算，但任务调度过程还是无法规避的</li></ul><p>在这些因素下，“避免重复计算”所节约的资源是否能大于检查点机制自身耗费的资源，可以说是一个未知数。对于这个问题，我们没有标准答案，只能基于自身的业务情况和机器资源，去寻找最优解。</p></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/spark/Spark 应用提交"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Spark 应用提交</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/spark/Spark 共享变量"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Spark 共享变量</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#rdd-基本概念" class="table-of-contents__link toc-highlight">RDD 基本概念</a></li><li><a href="#rdd-创建" class="table-of-contents__link toc-highlight">RDD 创建</a></li><li><a href="#rdd-分区" class="table-of-contents__link toc-highlight">RDD 分区</a></li><li><a href="#rdd-算子" class="table-of-contents__link toc-highlight">RDD 算子</a><ul><li><a href="#转换算子" class="table-of-contents__link toc-highlight">转换算子</a></li><li><a href="#行动算子" class="table-of-contents__link toc-highlight">行动算子</a></li></ul></li><li><a href="#rdd-依赖关系" class="table-of-contents__link toc-highlight">RDD 依赖关系</a><ul><li><a href="#窄依赖" class="table-of-contents__link toc-highlight">窄依赖</a></li><li><a href="#宽依赖" class="table-of-contents__link toc-highlight">宽依赖</a></li></ul></li><li><a href="#rdd-血缘关系" class="table-of-contents__link toc-highlight">RDD 血缘关系</a></li><li><a href="#rdd-持久化" class="table-of-contents__link toc-highlight">RDD 持久化</a><ul><li><a href="#图解说明" class="table-of-contents__link toc-highlight">图解说明</a></li><li><a href="#复用原理" class="table-of-contents__link toc-highlight">复用原理</a></li><li><a href="#存储级别" class="table-of-contents__link toc-highlight">存储级别</a></li></ul></li><li><a href="#rdd-检查点" class="table-of-contents__link toc-highlight">RDD 检查点</a><ul><li><a href="#实现原理" class="table-of-contents__link toc-highlight">实现原理</a></li><li><a href="#使用示例" class="table-of-contents__link toc-highlight">使用示例</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Recommend</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs">Spark</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/flink">Flink</a></li></ul></div><div class="col footer__col"><div class="footer__title">Other</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs/clickhouse">ClickHouse</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/flume">Flume</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/spider">Spider</a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/magicpenta" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">Legal</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://opensource.fb.com/legal/privacy/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Privacy<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://opensource.fb.com/legal/cookie-policy/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Cookie Policy<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="margin-bottom--sm"><img src="/img/bottom.png" alt="Panda Logo" class="themedImage_ToTc themedImage--light_HNdA footer__logo"><img src="/img/bottom.png" alt="Panda Logo" class="themedImage_ToTc themedImage--dark_i4oU footer__logo"></div><div class="footer__copyright">Copyright © 2023 Panda's Home</div></div></div></footer></div>
<script src="/assets/js/runtime~main.e2f7f3df.js"></script>
<script src="/assets/js/main.4ed9c8f6.js"></script>
</body>
</html>