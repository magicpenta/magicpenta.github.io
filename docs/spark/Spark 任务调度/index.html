<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-spark/Spark 任务调度">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.2.0">
<title data-rh="true">Spark 任务调度 | Panda Home</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://magicpenta.github.io/docs/spark/Spark 任务调度"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Spark 任务调度 | Panda Home"><meta data-rh="true" name="description" content="任务调度概述"><meta data-rh="true" property="og:description" content="任务调度概述"><link data-rh="true" rel="icon" href="/img/logo.svg"><link data-rh="true" rel="canonical" href="https://magicpenta.github.io/docs/spark/Spark 任务调度"><link data-rh="true" rel="alternate" href="https://magicpenta.github.io/docs/spark/Spark 任务调度" hreflang="en"><link data-rh="true" rel="alternate" href="https://magicpenta.github.io/docs/spark/Spark 任务调度" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Panda Home RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Panda Home Atom Feed"><link rel="stylesheet" href="/assets/css/styles.05fef033.css">
<link rel="preload" href="/assets/js/runtime~main.e2f7f3df.js" as="script">
<link rel="preload" href="/assets/js/main.4ed9c8f6.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#docusaurus_skipToContent_fallback">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="Panda Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/logo.svg" alt="Panda Logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">Panda Home</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs">Docs</a><a class="navbar__item navbar__link" href="/blog">Blog</a><a class="navbar__item navbar__link" href="/about">About</a></div><div class="navbar__items navbar__items--right"><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebar_njMd"><nav class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/docs/">Spark</a><button aria-label="Toggle the collapsible sidebar category &#x27;Spark&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/spark/Spark 快速入门">Spark 快速入门</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/spark/Spark 集群部署">Spark 集群部署</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/spark/Spark 应用提交">Spark 应用提交</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/spark/Spark RDD">Spark RDD</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/spark/Spark 共享变量">Spark 共享变量</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/spark/Spark 任务调度">Spark 任务调度</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/spark/Spark Shuffle">Spark Shuffle</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/spark/Spark Streaming 入门指南">Spark Streaming 入门指南</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/spark/Spark Streaming 集成 Kafka">Spark Streaming 集成 Kafka</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="true" href="/docs/flink/">Flink</a><button aria-label="Toggle the collapsible sidebar category &#x27;Flink&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/flink/Flink 快速入门">Flink 快速入门</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/flink/Flink 工作流程剖析">Flink 工作流程剖析</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/flink/Flink DataStream API">Flink DataStream API</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/flink/Flink Window">Flink Window</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/flink/Flink Watermark">Flink Watermark</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/flink/Flink 状态管理">Flink 状态管理</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/flink/Flink 容错机制">Flink 容错机制</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="true" href="/docs/clickhouse/">ClickHouse</a><button aria-label="Toggle the collapsible sidebar category &#x27;ClickHouse&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/clickhouse/ClickHouse 安装与启动">ClickHouse 安装与启动</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/clickhouse/ClickHouse JDBC">ClickHouse JDBC</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/clickhouse/ClickHouse 数据类型">ClickHouse 数据类型</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/clickhouse/ClickHouse 表引擎">ClickHouse 表引擎</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/clickhouse/ClickHouse SQL">ClickHouse SQL</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="true" href="/docs/flume/">Flume</a><button aria-label="Toggle the collapsible sidebar category &#x27;Flume&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/flume/Flume 集群部署（Docker）">Flume 集群部署（Docker）</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/flume/Flume 配置指南">Flume 配置指南</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/flume/Flume 负载均衡选择器">Flume 负载均衡选择器</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/flume/Flume ElasticSearch Sink">Flume ElasticSearch Sink（异步）</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/flume/Flume 自定义监控">Flume 自定义监控</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="true" href="/docs/spider/">Java 爬虫</a><button aria-label="Toggle the collapsible sidebar category &#x27;Java 爬虫&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/spider/使用 HttpClient 实现页面源码下载">使用 HttpClient 实现页面源码下载</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/spider/页面解析详细指南">页面解析详细指南</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/spider/基于 HtmlParser 实现网页链接提取">基于 HtmlParser 实现网页链接提取</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/spider/一个简易 Java 爬虫程序的实现">一个简易 Java 爬虫程序的实现</a></li></ul></li></ul></nav></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_OVgt"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/"><span itemprop="name">Spark</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Spark 任务调度</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h1>Spark 任务调度</h1><h2 class="anchor anchorWithStickyNavbar_LWe7" id="任务调度概述">任务调度概述<a class="hash-link" href="#任务调度概述" title="Direct link to heading">​</a></h2><p>任务调度并非 Spark Core 中的必修内容，但掌握任务调度的原理对于 <strong>提升开发人员在 Spark 应用程序上的故障排查和性能调优的能力</strong> 大有裨益。</p><p>当然，掌握任务调度原理绝非易事。一方面，作为大型分布式计算框架，Spark 的任务调度逻辑比较复杂；另一方面，现有的 Spark 教程对于任务调度部分大多数是浅尝辄止，没有过多展开。因此，学习 Spark 任务调度原理，更多的还需要依靠自身去阅读源码。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="基本概念">基本概念<a class="hash-link" href="#基本概念" title="Direct link to heading">​</a></h3><p>本文基于 <strong>Spark 3.1.2</strong> 版本来谈谈 Spark 的任务调度流程，受限于当前的能力和水平，只能从较粗的粒度来介绍这部分内容，但其中涉及到的模块和组件，会尽可能地介绍到。</p><p>在展开介绍前，我们首先需要掌握两方面的概念。</p><p><strong>第一方面，是理清 Application、Job、Stage、Task 的含义及关联。</strong></p><table><thead><tr><th><strong>名称</strong></th><th><strong>含义</strong></th></tr></thead><tbody><tr><td>Application</td><td>指用户提交的 Spark 应用程序</td></tr><tr><td>Job</td><td>指 Spark 作业，是 Application 的子集，由行动算子（action）触发</td></tr><tr><td>Stage</td><td>指 Spark 阶段，是 Job 的子集，以 RDD 的宽依赖为界</td></tr><tr><td>Task</td><td>指 Spark 任务，是 Stage 的子集，Spark 中最基本的任务执行单元，对应单个线程，会被封装成 TaskDescription 对象提交到 Executor 的线程池中执行</td></tr></tbody></table><p><strong>第二方面，是了解 Driver 和 Executor 在任务调度中扮演的角色。</strong></p><p>Driver 是运行用户程序 <code>main()</code> 函数并创建 SparkContext 的实例，是任务调度中最为关键的部分。</p><p>在一个完整的任务调度中，用户提交的程序会经历 <strong><em>Application → Job → Stage → Task</em></strong> 的转化过程，而这整个转化过程，由 Driver 的 3 大核心模块共同完成，它们的名称与职责如下表所示：</p><table><thead><tr><th><strong>模块名称</strong></th><th><strong>模块职责</strong></th></tr></thead><tbody><tr><td>DAGScheduler</td><td>DAG 调度器，负责阶段（Stage）的划分并生成 TaskSet 传递给 TaskScheduler</td></tr><tr><td>TaskScheduler</td><td>Task 调度器，决定任务池调度策略，负责 Task 的管理（包括 Task 的提交与销毁）</td></tr><tr><td>SchedulerBackend</td><td>调度后端，维持与 Executor 的通信，并负责将 Task 提交到 Executor</td></tr></tbody></table><p>Executor 是执行实际计算任务的实例，是任务调度的终点，它包含以下核心模块：</p><table><thead><tr><th><strong>模块名称</strong></th><th><strong>模块功能</strong></th></tr></thead><tbody><tr><td>ThreadPool</td><td>任务执行线程池，用于执行 Driver 提交过来的 Task</td></tr><tr><td>BlockManager</td><td>存储管理器，为 RDD 提供缓存服务，可提高计算速率</td></tr><tr><td>ExecutorBackend</td><td>Executor 调度后端，维持与 Driver 的通信，并负责将任务执行结果反馈给 Driver</td></tr></tbody></table><h3 class="anchor anchorWithStickyNavbar_LWe7" id="调度流程">调度流程<a class="hash-link" href="#调度流程" title="Direct link to heading">​</a></h3><p>Spark 任务调度基本上会经历 <strong><em>提交 → Stage 划分 → Task 调度 → Task 执行</em></strong>，这个过程大致可以描述为：</p><ol><li>用户提交一个计算应用（Application）</li><li>Driver 执行用户程序中的 <code>main()</code> 方法，根据行动算子提取作业（Job）</li><li>DAGScheduler 解析各个作业的 DAG 进行阶段（Stage）划分和任务集（TaskSet）组装</li><li>TaskScheduler 将任务集发送至任务队列 rootPool</li><li>SchedulerBackend 通过 Cluster Manager 获取 Executor 资源，并将任务（Task）发送给 Executor</li><li>Executor 执行计算并管理存储块（Block）</li><li>Driver 最终从 Executor 获得计算结果，汇总后返回给用户</li></ol><div class="theme-admonition theme-admonition-info alert alert--info admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_S0QG"><p>DAG（Directed Acyclic Graph）是一个有向无环图，由点和线组成，该图具有方向，不会闭环。</p></div></div><p>该过程也可以使用流程图来表示：</p><p><img loading="lazy" src="/assets/images/schedule-2b55552742ce32a978b8c370ff080f30.svg" width="2212" height="785" class="img_ev3q"></p><p>当然，这个过程描述是比较粗粒度的，无法帮助我们了解里面的实现细节。比如说，Stage 是怎么划分的？Task 是怎么进行调度的？Task 是怎么执行的？但是，只要能帮助我们了解大致的过程，以及这个过程出现的模块及组件，那么它的任务便算完成了。具体的实现原理和过程，将在下文逐一介绍。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="stage-划分">Stage 划分<a class="hash-link" href="#stage-划分" title="Direct link to heading">​</a></h2><p>Stage 划分是任务调度的第一步，由 DAGScheduler 完成，它决定了 <strong>一个 Job 将被划分为多少个 TaskSet</strong>。</p><p>本节将介绍 Stage 的基本概念以及划分规则，并对其代码实现展开简单描述。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="基本概念-1">基本概念<a class="hash-link" href="#基本概念-1" title="Direct link to heading">​</a></h3><p>相较于 Task，Stage 的定义显得难以理解。在官方定义上，<strong>Stage 是一个并行任务（Task）的集合，这个集合上的 Task，都来源于同一个 Job，具有相同的计算逻辑。</strong></p><p>对于部分初学者来说，看到 Stage 的概念可能有此困惑：已知 Task 是实际执行计算任务的单元，为何还需要 Stage 这个集合的概念？将 Job 直接拆分成一系列 Task 然后提交执行不就好了吗？实际上，一个计算作业的执行绝不是简单地拆分、提交 Task 那么简单，它还需要考虑 Task 之间的执行顺序、数据流转等问题。</p><p>以 WordCount 为例，计算需要经历 <code>flatMap</code> →  <code>map</code> → <code>reduceByKey</code> 的过程，其中 <code>reduceByKey</code> 需要在获取前序阶段的所有计算结果后才可以运行。在分布式计算中，由于数据是分散在多个节点的，计算任务会被分发到各节点执行，如果不考虑 Task 执行顺序的话，那么一旦 <code>reduceByKey</code> 提前运行，用户将得到错误的结果。因此，必须有一个 Task 调度机制，告诉 Spark 集群哪些 Task 先执行、哪些 Task 后执行。而这，便是 Stage 存在的意义，是它帮助 Spark 任务调度构建了蓝图。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="划分规则">划分规则<a class="hash-link" href="#划分规则" title="Direct link to heading">​</a></h3><p>Stage 的划分方式可以简述为：<strong>在 DAG 中进行反向解析，遇到宽依赖就断开，遇到窄依赖就把当前的 RDD 加入到当前的阶段中。</strong>之所以这样划分，是因为宽依赖的位置意味着 Shuffle 的发生，表示这个位置后的 RDD 需要等待前序 RDD 计算完成后才可以开始计算。</p><p>下图为 Stage 划分的示例：</p><p><img loading="lazy" src="/assets/images/stage-757fe4092f6c4a8c87380f928f67d108.svg" width="1660" height="1370" class="img_ev3q"></p><p>在这个示例中，DAGScheduler 反向解析，在 <strong><em>RDD B → RDD A</em></strong> 和 <strong><em>RDD G → RDD F</em></strong> 间发现 <strong>ShuffleDependency</strong>，于是在这两个位置进行阶段划分，分别得到 Stage 01、Stage 02 和 Stage 03。其中，Stage 01 和 Stage 02 的类型为 <strong>ShuffleMapStage</strong>，而 Stage 03 的类型为 <strong>ResultStage</strong>。 </p><div class="theme-admonition theme-admonition-caution alert alert--warning admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>caution</div><div class="admonitionContent_S0QG"><p>ShuffleDependency 保存在 Shuffle 后面的 RDD 中，但是在阶段划分时，会赋予 Shuffle 前的 Stage。例如，RDD B 的 ShuffleDependency 会赋予 Stage 01 的 ShuffleMapStage，以便于 ShuffleMapTask 可以获取到 ShuffleDependency 中的重要信息。这一点，在后续的 Shuffle 教程中得以体现。</p></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="代码实现">代码实现<a class="hash-link" href="#代码实现" title="Direct link to heading">​</a></h3><p>Stage 划分的代码实现可以参考下图：</p><p><img loading="lazy" src="/assets/images/stage_split-d51ed4c75485da05472ccbdb5ea7c64e.svg" width="1232" height="602" class="img_ev3q"></p><p>该图为 DAGScheduler 中关于阶段划分的源码实现，简单来说就是：</p><ol><li>用户提交作业，<code>handleJobSubmitted</code> 方法通过最后一个 RDD 解析出 ResultStage并提交给 <code>submitStage</code> 方法</li><li><code>submitStage</code> 方法调用 <code>getMissingParentStages</code> 反向解析，提取 ResultStage 的 Parent Stage</li><li>若无 Parent Stage，直接调用 <code>submitMissingTasks</code> 方法，生成该阶段下的 TaskSet</li><li>若存在 Parent Stage，将其添加到到队列 <code>waitingStages</code> 中</li><li>当前序任务完成，<code>handleTaskCompletion</code> 会从 <code>waitingStages</code> 取出剩余的 Stage（可能既有 ShuffleMapStage 和 ResultStage）并提交，直至生成所有阶段的 TaskSet</li></ol><div class="theme-admonition theme-admonition-caution alert alert--warning admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>caution</div><div class="admonitionContent_S0QG"><p>可以看出，Stage 划分的最终产物是 TaskSet，它是一组 Task 序列，<strong>与 Stage 是一一对应的关系</strong>，其中的 Task 均来自于同一个 Stage，<strong>且 Task 数量与 Stage 中最后一个 RDD 的分区数一致。</strong></p></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="rpc-模块">RPC 模块<a class="hash-link" href="#rpc-模块" title="Direct link to heading">​</a></h2><p>通过 Stage 划分，我们已经获得了任务集 TaskSet，可以进入到 Task 调度阶段。但是，Task 调度阶段中包含了大量 RPC 交互过程，因此我们有必要提前了解一下 Spark 的 RPC 模块。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="核心概念">核心概念<a class="hash-link" href="#核心概念" title="Direct link to heading">​</a></h3><p>Spark 的 RPC 模块主要负责 Spark 集群中各节点间（比如 Driver 与 Executor）通信功能的实现。</p><p>自 2.x 版本后，Spark 剥离了 RPC 框架 Akka，并基于 Netty 实现了新的 RPC 框架。尽管 Akka 已经被剥离，但新版的 RPC 框架仍然借鉴了 Akka 的 Actor 模型的设计思想，<strong>以 RpcEnv、RpcEndpoint、RpcEndpointRef 分别替代 Actor 中的 ActorSystem、Actor、ActorRef。</strong></p><hr><p><strong>RpcEnv</strong></p><p>RPC 上下文环境，负责 RpcEndpoint 整个生命周期的管理（包括 RpcEndpoint 的注册、停止等）。</p><p><strong>RpcEndpoint</strong></p><p>进行消息处理的通信终端（可位于 Master、Worker、Driver 等），它的生命周期包含如下过程：</p><p><strong><em>constructor → onStart → receive</em> → onStop*</strong></p><p>其中，<code>receive*</code> 分为 <code>receive</code> 和 <code>receiveAndReply</code> 两种方法，前者用于响应 RpcEndpointRef 的 <code>send</code> 请求，后者用于响应 RpcEndpointRef 的 <code>ask</code> 请求。</p><p><strong>RpcEndpointRef</strong></p><p>RpcEndpoint 的一个引用，包含了远程地址 <code>RpcAddress</code>，可通过 <code>send</code> 或 <code>ask</code> 向 RpcEndpoint 发送消息。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="通信过程">通信过程<a class="hash-link" href="#通信过程" title="Direct link to heading">​</a></h3><p>RpcEnv、RpcEndpoint、RpcEndpointRef 间的关系如下图所示：</p><p><img loading="lazy" src="/assets/images/rpc-9c14deeef19eeab068bb46e32e420481.svg" width="1476" height="983" class="img_ev3q"></p><p>通过该图，我们可以简单描述 RPC 模块的通信过程：</p><ol><li>在 RpcEnv 中注册 RpcEndpoint</li><li>启动 RpcEndpoint，获取一个 RpcEndpoint 的引用 RpcEndpointRef</li><li>RpcEndpointRef 通过 <code>send</code> 或 <code>ask</code> 方法往 OutBoxes 写入消息</li><li>RpcEndpoint 通过 <code>receive*</code> 方法从 InBox 读取消息并处理</li></ol><div class="theme-admonition theme-admonition-info alert alert--info admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_S0QG"><p>InBox 可以为 RpcEndpoint 缓存和传递发送给它的消息，OutBox 可以向其他 RpcEndpoint 发送消息。每个 RpcEndpoint 对应 1 个 InBox 和 N 个 OutBox（N ≥ 1）。</p></div></div><div class="theme-admonition theme-admonition-caution alert alert--warning admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>caution</div><div class="admonitionContent_S0QG"><p>实际上，RPC 的通信过程复杂得多，还涉及到 Dispatcher、MessageLoop 等组件。本节只为简单地阐述一下这个过程，为后续学习 Task 调度打好理论基础，并不对该部分展开详细介绍。</p></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="task-调度">Task 调度<a class="hash-link" href="#task-调度" title="Direct link to heading">​</a></h2><p>Task 调度是本文最后一节也是最为核心的部分。它是一个非常复杂的过程，涉及到 DAGScheduler、TaskScheduler、SchedulerBackend、ExecutorBackend、Executor 等多个模块。</p><p>一个相对完整的 Task 调度流转图如下所示：</p><p><img loading="lazy" src="/assets/images/total_schedule-d72ae4cd2c18c55f98e234a9ae613875.svg" width="2746" height="1528" class="img_ev3q"></p><p>在这个流转图中，我们可以将 Task 调度大致分为 5 个阶段：</p><ul><li>初始化阶段：初始化 TaskScheduler 和 SchedulerBackend 的阶段</li><li>提交阶段：任务提交到任务池 rootPool 的阶段</li><li>启动阶段：从任务池 rootPool 取出任务并发布到 Executor 的阶段</li><li>执行阶段：Executor 执行计算任务并存储计算结果的阶段</li><li>回收阶段：任务回收、状态更新与资源释放的阶段</li></ul><div class="theme-admonition theme-admonition-info alert alert--info admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_S0QG"><p>调度流程图根据 Standalone 模式下的流转情况进行绘制，Local、Yarn 等模式下的流转过程会有些许区别。</p></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="初始化阶段">初始化阶段<a class="hash-link" href="#初始化阶段" title="Direct link to heading">​</a></h3><p>在前面，我们提到过：</p><ul><li>TaskScheduler 是 Task 调度器，负责 Task 的管理，包括提交（提交给任务池 rootPool）、回收、销毁等</li><li>SchedulerBackend 是调度后端，负责与 Executor 保持通信，并负责 Task 的提交（提交给 Executor）</li></ul><p>所谓初始化阶段便是 SparkContext 调用 <code>createTaskScheduler</code> 方法创建 TaskScheduler 和 SchedulerBackend 实例并完成初始化的过程，其流程图如下所示：</p><p><img loading="lazy" src="/assets/images/initial-196ae5e8eb8cf5ae95025b136eb18baf.svg" width="1473" height="1043" class="img_ev3q"></p><p>在初始化阶段，TaskScheduler 主要完成以下工作：</p><ul><li>初始化 SchedulableBuilder，决定任务调度策略，创建任务池 rootPool</li><li>启动 SchedulerBackend</li></ul><p>SchedulerBackend 主要完成以下工作：</p><ul><li>创建并维持与 Executor 间的 RPC 连接</li><li>申请 Executor 资源</li></ul><p>与 TaskScheduler 基本只有 TaskSchedulerImpl 一个实现类不同，SchedulerBackend 的实现类非常多，大体如下：</p><p><img loading="lazy" src="/assets/images/scheduler_backend-004f22a4fc4e3ffe305eb5a5f1e55383.svg" width="1983" height="743" class="img_ev3q"></p><p>实际上，SchedulerBackend 对 Executor 的资源申请在很多情况下是由 Cluster Manager （Yarn、Mesos 等）完成的，也正是因为这个原因，SchedulerBackend 拥有着非常多的实现类。</p><p>受限于篇幅，本文仅介绍 Standalone 模式下申请 Executor 的过程，对其他模式不展开介绍，其过程如下：</p><p><img loading="lazy" src="/assets/images/request_executor-c00211cdc5ba1457c30261b8163a764c.svg" width="3762" height="1582" class="img_ev3q"></p><div class="theme-admonition theme-admonition-info alert alert--info admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_S0QG"><p>在 Driver、Master、Worker 间存在多个 RPC 终端（RpcEndPoint），为避免图例过长，省略了此部分内容。</p></div></div><p>在这个过程中，Executor 的创建发生在 CoarseGrainedExecutorBackend。它是 Executor 的调度后端，会建立与 Driver 的通信连接，然后创建 Executor 实例并将 Executor 的信息传递给 Driver。接收到 Executor 资源后，Driver 端的SchedulerBackend 会将 Executor 资源放入 <code>executorDataMap</code>，等待 Task 调度时提取。</p><div class="theme-admonition theme-admonition-caution alert alert--warning admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>caution</div><div class="admonitionContent_S0QG"><p>CoarseGrainedExecutorBackend 是一个独立的进程，由 ExecuteRunner 调用 Java 的 Process 类库启动，并非是 Worker 进程的一部分。</p></div></div><div class="theme-admonition theme-admonition-danger alert alert--danger admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M5.05.31c.81 2.17.41 3.38-.52 4.31C3.55 5.67 1.98 6.45.9 7.98c-1.45 2.05-1.7 6.53 3.53 7.7-2.2-1.16-2.67-4.52-.3-6.61-.61 2.03.53 3.33 1.94 2.86 1.39-.47 2.3.53 2.27 1.67-.02.78-.31 1.44-1.13 1.81 3.42-.59 4.78-3.42 4.78-5.56 0-2.84-2.53-3.22-1.25-5.61-1.52.13-2.03 1.13-1.89 2.75.09 1.08-1.02 1.8-1.86 1.33-.67-.41-.66-1.19-.06-1.78C8.18 5.31 8.68 2.45 5.05.32L5.03.3l.02.01z"></path></svg></span>danger</div><div class="admonitionContent_S0QG"><p>Executor 的申请是一个异步的过程，并不会阻塞 Driver 程序的运行。这里引出了一个问题，如果 Executor 因为种种原因迟迟申请不下来（在 Yarn 模式下这种情况很常见），那么 Driver 程序发布的任务是否会因为获取不到 Executor 而失败？这一点我们将在 <strong>启动阶段</strong> 给出答案。</p></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="提交阶段">提交阶段<a class="hash-link" href="#提交阶段" title="Direct link to heading">​</a></h3><p>提交阶段由 TaskScheduler 的 <code>submitTasks</code> 方法触发，它主要完成以下工作：</p><ul><li>创建 TaskSetManager</li><li>将 TaskSetManager 添加至任务池 rootPool</li></ul><p>在这个过程中，存在着两个核心角色：TaskSetManager 和 SchedulableBuilder。</p><p><strong>TaskSetManager</strong></p><p>TaskSetManager 由 TaskScheduler 封装 TaskSet 而来，是 TaskScheduler 进行任务调度的基本单元：</p><p><img loading="lazy" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiB2ZXJzaW9uPSIxLjEiIHdpZHRoPSIxNDAycHgiIGhlaWdodD0iNDIycHgiIHZpZXdCb3g9Ii0wLjUgLTAuNSAxNDAyIDQyMiIgY29udGVudD0iJmx0O214ZmlsZSBzY2FsZT0mcXVvdDsyJnF1b3Q7IGJvcmRlcj0mcXVvdDszMCZxdW90OyZndDsmbHQ7ZGlhZ3JhbSBpZD0mcXVvdDswUWh0d3FNanBtY19BTy1NclJiNCZxdW90OyBuYW1lPSZxdW90O+esrCAxIOmhtSZxdW90OyZndDs3WmhObDVvd0ZJWi9EZHNlSUFSbFdUOW9ON095cDExbklBTTVFNGlOc1doL2ZTOXlFYUo0UnFlYzR3WTNrdmZtRXZJK041am9rR1Z4K0tiWk5uOVJLWmVPNzZZSGg2d2MzL2VvNjhOWHJSd2JaUjZTUnNpMFNMRlRKMnpFWDQ2aWkrcGVwSHhuZFRSS1NTTzJ0cGlvc3VTSnNUU210YXJzYm05SzJxTnVXY2F2aEUzQzVMWDZTNlFtUnpXa1FSZjR6a1dXNDlBK0lXRVRLVmpiRzZleXkxbXFxcDVFMWc1WmFxVk1jMVVjbGx6VzdyWEdOSG54amVqNXlUUXZ6VDBKTXpKclV2NHd1Y2ZwNFpPWll6dGZyZlpseXVzTTF5R0xLaGVHYjdZc3FhTVZFQVl0TjRXRWxnZVhiMExLcFpKS24zTEplaFg3Y1FENnptajF6dHRJcVVwSVgrRFlYQnQrdURrRDcrd0xWQlJYQlRmNkNGMHdJVUFuajNhejZzQ0VNOVR5SGhOdmppTERZc2pPZCs3c2dndDA3SVo3QVJuYlBWVWFMSGd2d0hiUHpmajB1ZVhtaGZVa29ENGw0N2hNWjErbzVmTjh3R2RDQjN6MjZRZytrL21BejZFMDZGQzlpQnRIUWYyOXJ4ZlA0aWZYS1N0Wko4QlZWbi8vWUx2M05oa0didktiMFAreEcyWlNBOFViRGdLMm1jWHhLZ3JEY1poRjlzcndXanc5Wk5IQXlxQmpMQXdTVGNBZUJuYitnWHNHc2ZiRk9SRjdnQmdoenlUbVRjUWUzeTdRWnhMekoyS2YySG84azFnd0hyRTI4YldQY01OTmorTHJaZCtQeUlLdDVoNThQVHdvTVNteUVwb0pZT0NnTDJwSUFnNDVYekZRaURTdGh4bXNGN3VpN3QyMWp2SEdwZlkrMUhPdk42TEJRRFg0bzFRREhhTWE0RnphV3RPSjdXNzk3cXA1Z2J0bUFHNHFuZ2MyV05IbE1ZWmVWNDlIQjQ0eG55Z2ZhSGJuK0ZPczkzY0lXZjhEJmx0Oy9kaWFncmFtJmd0OyZsdDsvbXhmaWxlJmd0OyI+PGRlZnMvPjxnPjxyZWN0IHg9IjMwIiB5PSIzMCIgd2lkdGg9IjEzNDAiIGhlaWdodD0iMzYwIiBmaWxsPSIjZWRmMmY0IiBzdHJva2U9Im5vbmUiIHBvaW50ZXItZXZlbnRzPSJhbGwiLz48cmVjdCB4PSI2NSIgeT0iMTEwIiB3aWR0aD0iMTI3MCIgaGVpZ2h0PSIyNTAiIGZpbGw9IiMzNDUyNTMiIHN0cm9rZT0ibm9uZSIgcG9pbnRlci1ldmVudHM9ImFsbCIvPjxyZWN0IHg9IjEzMCIgeT0iMjIwIiB3aWR0aD0iMTgwIiBoZWlnaHQ9IjEwMCIgZmlsbD0iI2ZmZDk2NiIgc3Ryb2tlPSJub25lIiBwb2ludGVyLWV2ZW50cz0iYWxsIi8+PGcgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoLTAuNSAtMC41KXNjYWxlKDIpIj48c3dpdGNoPjxmb3JlaWduT2JqZWN0IHN0eWxlPSJvdmVyZmxvdzogdmlzaWJsZTsgdGV4dC1hbGlnbjogbGVmdDsiIHBvaW50ZXItZXZlbnRzPSJub25lIiB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiByZXF1aXJlZEZlYXR1cmVzPSJodHRwOi8vd3d3LnczLm9yZy9UUi9TVkcxMS9mZWF0dXJlI0V4dGVuc2liaWxpdHkiPjxkaXYgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkveGh0bWwiIHN0eWxlPSJkaXNwbGF5OiBmbGV4OyBhbGlnbi1pdGVtczogdW5zYWZlIGNlbnRlcjsganVzdGlmeS1jb250ZW50OiB1bnNhZmUgY2VudGVyOyB3aWR0aDogODhweDsgaGVpZ2h0OiAxcHg7IHBhZGRpbmctdG9wOiAxMzVweDsgbWFyZ2luLWxlZnQ6IDY2cHg7Ij48ZGl2IHN0eWxlPSJib3gtc2l6aW5nOiBib3JkZXItYm94OyBmb250LXNpemU6IDA7IHRleHQtYWxpZ246IGNlbnRlcjsgIj48ZGl2IHN0eWxlPSJkaXNwbGF5OiBpbmxpbmUtYmxvY2s7IGZvbnQtc2l6ZTogMTRweDsgZm9udC1mYW1pbHk6IEhlbHZldGljYTsgY29sb3I6ICMwMDAwMDA7IGxpbmUtaGVpZ2h0OiAxLjI7IHBvaW50ZXItZXZlbnRzOiBhbGw7IGZvbnQtd2VpZ2h0OiBib2xkOyB3aGl0ZS1zcGFjZTogbm9ybWFsOyB3b3JkLXdyYXA6IG5vcm1hbDsgIj48Zm9udCBmYWNlPSJWZXJkYW5hIj5UYXNrPC9mb250PjwvZGl2PjwvZGl2PjwvZGl2PjwvZm9yZWlnbk9iamVjdD48dGV4dCB4PSIxMTAiIHk9IjEzOSIgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9IkhlbHZldGljYSIgZm9udC1zaXplPSIxNHB4IiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmb250LXdlaWdodD0iYm9sZCI+VGFzazwvdGV4dD48L3N3aXRjaD48L2c+PHJlY3QgeD0iMzcwIiB5PSIyMjAiIHdpZHRoPSIxODAiIGhlaWdodD0iMTAwIiBmaWxsPSIjZmZkOTY2IiBzdHJva2U9Im5vbmUiIHBvaW50ZXItZXZlbnRzPSJhbGwiLz48ZyB0cmFuc2Zvcm09InRyYW5zbGF0ZSgtMC41IC0wLjUpc2NhbGUoMikiPjxzd2l0Y2g+PGZvcmVpZ25PYmplY3Qgc3R5bGU9Im92ZXJmbG93OiB2aXNpYmxlOyB0ZXh0LWFsaWduOiBsZWZ0OyIgcG9pbnRlci1ldmVudHM9Im5vbmUiIHdpZHRoPSIxMDAlIiBoZWlnaHQ9IjEwMCUiIHJlcXVpcmVkRmVhdHVyZXM9Imh0dHA6Ly93d3cudzMub3JnL1RSL1NWRzExL2ZlYXR1cmUjRXh0ZW5zaWJpbGl0eSI+PGRpdiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94aHRtbCIgc3R5bGU9ImRpc3BsYXk6IGZsZXg7IGFsaWduLWl0ZW1zOiB1bnNhZmUgY2VudGVyOyBqdXN0aWZ5LWNvbnRlbnQ6IHVuc2FmZSBjZW50ZXI7IHdpZHRoOiA4OHB4OyBoZWlnaHQ6IDFweDsgcGFkZGluZy10b3A6IDEzNXB4OyBtYXJnaW4tbGVmdDogMTg2cHg7Ij48ZGl2IHN0eWxlPSJib3gtc2l6aW5nOiBib3JkZXItYm94OyBmb250LXNpemU6IDA7IHRleHQtYWxpZ246IGNlbnRlcjsgIj48ZGl2IHN0eWxlPSJkaXNwbGF5OiBpbmxpbmUtYmxvY2s7IGZvbnQtc2l6ZTogMTRweDsgZm9udC1mYW1pbHk6IEhlbHZldGljYTsgY29sb3I6ICMwMDAwMDA7IGxpbmUtaGVpZ2h0OiAxLjI7IHBvaW50ZXItZXZlbnRzOiBhbGw7IGZvbnQtd2VpZ2h0OiBib2xkOyB3aGl0ZS1zcGFjZTogbm9ybWFsOyB3b3JkLXdyYXA6IG5vcm1hbDsgIj48Zm9udCBmYWNlPSJWZXJkYW5hIj5UYXNrPC9mb250PjwvZGl2PjwvZGl2PjwvZGl2PjwvZm9yZWlnbk9iamVjdD48dGV4dCB4PSIyMzAiIHk9IjEzOSIgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9IkhlbHZldGljYSIgZm9udC1zaXplPSIxNHB4IiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmb250LXdlaWdodD0iYm9sZCI+VGFzazwvdGV4dD48L3N3aXRjaD48L2c+PHJlY3QgeD0iNjEwIiB5PSIyMjAiIHdpZHRoPSIxODAiIGhlaWdodD0iMTAwIiBmaWxsPSIjZmZkOTY2IiBzdHJva2U9Im5vbmUiIHBvaW50ZXItZXZlbnRzPSJhbGwiLz48ZyB0cmFuc2Zvcm09InRyYW5zbGF0ZSgtMC41IC0wLjUpc2NhbGUoMikiPjxzd2l0Y2g+PGZvcmVpZ25PYmplY3Qgc3R5bGU9Im92ZXJmbG93OiB2aXNpYmxlOyB0ZXh0LWFsaWduOiBsZWZ0OyIgcG9pbnRlci1ldmVudHM9Im5vbmUiIHdpZHRoPSIxMDAlIiBoZWlnaHQ9IjEwMCUiIHJlcXVpcmVkRmVhdHVyZXM9Imh0dHA6Ly93d3cudzMub3JnL1RSL1NWRzExL2ZlYXR1cmUjRXh0ZW5zaWJpbGl0eSI+PGRpdiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94aHRtbCIgc3R5bGU9ImRpc3BsYXk6IGZsZXg7IGFsaWduLWl0ZW1zOiB1bnNhZmUgY2VudGVyOyBqdXN0aWZ5LWNvbnRlbnQ6IHVuc2FmZSBjZW50ZXI7IHdpZHRoOiA4OHB4OyBoZWlnaHQ6IDFweDsgcGFkZGluZy10b3A6IDEzNXB4OyBtYXJnaW4tbGVmdDogMzA2cHg7Ij48ZGl2IHN0eWxlPSJib3gtc2l6aW5nOiBib3JkZXItYm94OyBmb250LXNpemU6IDA7IHRleHQtYWxpZ246IGNlbnRlcjsgIj48ZGl2IHN0eWxlPSJkaXNwbGF5OiBpbmxpbmUtYmxvY2s7IGZvbnQtc2l6ZTogMTRweDsgZm9udC1mYW1pbHk6IEhlbHZldGljYTsgY29sb3I6ICMwMDAwMDA7IGxpbmUtaGVpZ2h0OiAxLjI7IHBvaW50ZXItZXZlbnRzOiBhbGw7IGZvbnQtd2VpZ2h0OiBib2xkOyB3aGl0ZS1zcGFjZTogbm9ybWFsOyB3b3JkLXdyYXA6IG5vcm1hbDsgIj48Zm9udCBmYWNlPSJWZXJkYW5hIj5UYXNrPC9mb250PjwvZGl2PjwvZGl2PjwvZGl2PjwvZm9yZWlnbk9iamVjdD48dGV4dCB4PSIzNTAiIHk9IjEzOSIgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9IkhlbHZldGljYSIgZm9udC1zaXplPSIxNHB4IiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmb250LXdlaWdodD0iYm9sZCI+VGFzazwvdGV4dD48L3N3aXRjaD48L2c+PHJlY3QgeD0iODUwIiB5PSIyMjAiIHdpZHRoPSIxODAiIGhlaWdodD0iMTAwIiBmaWxsPSIjZmZkOTY2IiBzdHJva2U9Im5vbmUiIHBvaW50ZXItZXZlbnRzPSJhbGwiLz48ZyB0cmFuc2Zvcm09InRyYW5zbGF0ZSgtMC41IC0wLjUpc2NhbGUoMikiPjxzd2l0Y2g+PGZvcmVpZ25PYmplY3Qgc3R5bGU9Im92ZXJmbG93OiB2aXNpYmxlOyB0ZXh0LWFsaWduOiBsZWZ0OyIgcG9pbnRlci1ldmVudHM9Im5vbmUiIHdpZHRoPSIxMDAlIiBoZWlnaHQ9IjEwMCUiIHJlcXVpcmVkRmVhdHVyZXM9Imh0dHA6Ly93d3cudzMub3JnL1RSL1NWRzExL2ZlYXR1cmUjRXh0ZW5zaWJpbGl0eSI+PGRpdiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94aHRtbCIgc3R5bGU9ImRpc3BsYXk6IGZsZXg7IGFsaWduLWl0ZW1zOiB1bnNhZmUgY2VudGVyOyBqdXN0aWZ5LWNvbnRlbnQ6IHVuc2FmZSBjZW50ZXI7IHdpZHRoOiA4OHB4OyBoZWlnaHQ6IDFweDsgcGFkZGluZy10b3A6IDEzNXB4OyBtYXJnaW4tbGVmdDogNDI2cHg7Ij48ZGl2IHN0eWxlPSJib3gtc2l6aW5nOiBib3JkZXItYm94OyBmb250LXNpemU6IDA7IHRleHQtYWxpZ246IGNlbnRlcjsgIj48ZGl2IHN0eWxlPSJkaXNwbGF5OiBpbmxpbmUtYmxvY2s7IGZvbnQtc2l6ZTogMTRweDsgZm9udC1mYW1pbHk6IEhlbHZldGljYTsgY29sb3I6ICMwMDAwMDA7IGxpbmUtaGVpZ2h0OiAxLjI7IHBvaW50ZXItZXZlbnRzOiBhbGw7IGZvbnQtd2VpZ2h0OiBib2xkOyB3aGl0ZS1zcGFjZTogbm9ybWFsOyB3b3JkLXdyYXA6IG5vcm1hbDsgIj48Zm9udCBmYWNlPSJWZXJkYW5hIj5UYXNrPC9mb250PjwvZGl2PjwvZGl2PjwvZGl2PjwvZm9yZWlnbk9iamVjdD48dGV4dCB4PSI0NzAiIHk9IjEzOSIgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9IkhlbHZldGljYSIgZm9udC1zaXplPSIxNHB4IiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmb250LXdlaWdodD0iYm9sZCI+VGFzazwvdGV4dD48L3N3aXRjaD48L2c+PHJlY3QgeD0iMTA5MCIgeT0iMjIwIiB3aWR0aD0iMTgwIiBoZWlnaHQ9IjEwMCIgZmlsbD0iI2ZmZDk2NiIgc3Ryb2tlPSJub25lIiBwb2ludGVyLWV2ZW50cz0iYWxsIi8+PGcgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoLTAuNSAtMC41KXNjYWxlKDIpIj48c3dpdGNoPjxmb3JlaWduT2JqZWN0IHN0eWxlPSJvdmVyZmxvdzogdmlzaWJsZTsgdGV4dC1hbGlnbjogbGVmdDsiIHBvaW50ZXItZXZlbnRzPSJub25lIiB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiByZXF1aXJlZEZlYXR1cmVzPSJodHRwOi8vd3d3LnczLm9yZy9UUi9TVkcxMS9mZWF0dXJlI0V4dGVuc2liaWxpdHkiPjxkaXYgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkveGh0bWwiIHN0eWxlPSJkaXNwbGF5OiBmbGV4OyBhbGlnbi1pdGVtczogdW5zYWZlIGNlbnRlcjsganVzdGlmeS1jb250ZW50OiB1bnNhZmUgY2VudGVyOyB3aWR0aDogODhweDsgaGVpZ2h0OiAxcHg7IHBhZGRpbmctdG9wOiAxMzVweDsgbWFyZ2luLWxlZnQ6IDU0NnB4OyI+PGRpdiBzdHlsZT0iYm94LXNpemluZzogYm9yZGVyLWJveDsgZm9udC1zaXplOiAwOyB0ZXh0LWFsaWduOiBjZW50ZXI7ICI+PGRpdiBzdHlsZT0iZGlzcGxheTogaW5saW5lLWJsb2NrOyBmb250LXNpemU6IDE0cHg7IGZvbnQtZmFtaWx5OiBIZWx2ZXRpY2E7IGNvbG9yOiAjMDAwMDAwOyBsaW5lLWhlaWdodDogMS4yOyBwb2ludGVyLWV2ZW50czogYWxsOyBmb250LXdlaWdodDogYm9sZDsgd2hpdGUtc3BhY2U6IG5vcm1hbDsgd29yZC13cmFwOiBub3JtYWw7ICI+PGZvbnQgZmFjZT0iVmVyZGFuYSI+VGFzazwvZm9udD48L2Rpdj48L2Rpdj48L2Rpdj48L2ZvcmVpZ25PYmplY3Q+PHRleHQgeD0iNTkwIiB5PSIxMzkiIGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJIZWx2ZXRpY2EiIGZvbnQtc2l6ZT0iMTRweCIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZm9udC13ZWlnaHQ9ImJvbGQiPlRhc2s8L3RleHQ+PC9zd2l0Y2g+PC9nPjxyZWN0IHg9IjY2MCIgeT0iMTUwIiB3aWR0aD0iODAiIGhlaWdodD0iNDAiIGZpbGw9Im5vbmUiIHN0cm9rZT0ibm9uZSIgcG9pbnRlci1ldmVudHM9ImFsbCIvPjxnIHRyYW5zZm9ybT0idHJhbnNsYXRlKC0wLjUgLTAuNSlzY2FsZSgyKSI+PHN3aXRjaD48Zm9yZWlnbk9iamVjdCBzdHlsZT0ib3ZlcmZsb3c6IHZpc2libGU7IHRleHQtYWxpZ246IGxlZnQ7IiBwb2ludGVyLWV2ZW50cz0ibm9uZSIgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgcmVxdWlyZWRGZWF0dXJlcz0iaHR0cDovL3d3dy53My5vcmcvVFIvU1ZHMTEvZmVhdHVyZSNFeHRlbnNpYmlsaXR5Ij48ZGl2IHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hodG1sIiBzdHlsZT0iZGlzcGxheTogZmxleDsgYWxpZ24taXRlbXM6IHVuc2FmZSBjZW50ZXI7IGp1c3RpZnktY29udGVudDogdW5zYWZlIGNlbnRlcjsgd2lkdGg6IDM4cHg7IGhlaWdodDogMXB4OyBwYWRkaW5nLXRvcDogODVweDsgbWFyZ2luLWxlZnQ6IDMzMXB4OyI+PGRpdiBzdHlsZT0iYm94LXNpemluZzogYm9yZGVyLWJveDsgZm9udC1zaXplOiAwOyB0ZXh0LWFsaWduOiBjZW50ZXI7ICI+PGRpdiBzdHlsZT0iZGlzcGxheTogaW5saW5lLWJsb2NrOyBmb250LXNpemU6IDE0cHg7IGZvbnQtZmFtaWx5OiBIZWx2ZXRpY2E7IGNvbG9yOiAjRkZGRkZGOyBsaW5lLWhlaWdodDogMS4yOyBwb2ludGVyLWV2ZW50czogYWxsOyB3aGl0ZS1zcGFjZTogbm9ybWFsOyB3b3JkLXdyYXA6IG5vcm1hbDsgIj48Zm9udCBmYWNlPSJWZXJkYW5hIj48Yj5UYXNrU2V0PC9iPjwvZm9udD48L2Rpdj48L2Rpdj48L2Rpdj48L2ZvcmVpZ25PYmplY3Q+PHRleHQgeD0iMzUwIiB5PSI4OSIgZmlsbD0iI0ZGRkZGRiIgZm9udC1mYW1pbHk9IkhlbHZldGljYSIgZm9udC1zaXplPSIxNHB4IiB0ZXh0LWFuY2hvcj0ibWlkZGxlIj5UYXNrU2V0PC90ZXh0Pjwvc3dpdGNoPjwvZz48cmVjdCB4PSI1NDUiIHk9IjUwIiB3aWR0aD0iMzEwIiBoZWlnaHQ9IjQwIiBmaWxsPSJub25lIiBzdHJva2U9Im5vbmUiIHBvaW50ZXItZXZlbnRzPSJhbGwiLz48ZyB0cmFuc2Zvcm09InRyYW5zbGF0ZSgtMC41IC0wLjUpc2NhbGUoMikiPjxzd2l0Y2g+PGZvcmVpZ25PYmplY3Qgc3R5bGU9Im92ZXJmbG93OiB2aXNpYmxlOyB0ZXh0LWFsaWduOiBsZWZ0OyIgcG9pbnRlci1ldmVudHM9Im5vbmUiIHdpZHRoPSIxMDAlIiBoZWlnaHQ9IjEwMCUiIHJlcXVpcmVkRmVhdHVyZXM9Imh0dHA6Ly93d3cudzMub3JnL1RSL1NWRzExL2ZlYXR1cmUjRXh0ZW5zaWJpbGl0eSI+PGRpdiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94aHRtbCIgc3R5bGU9ImRpc3BsYXk6IGZsZXg7IGFsaWduLWl0ZW1zOiB1bnNhZmUgY2VudGVyOyBqdXN0aWZ5LWNvbnRlbnQ6IHVuc2FmZSBjZW50ZXI7IHdpZHRoOiAxNTNweDsgaGVpZ2h0OiAxcHg7IHBhZGRpbmctdG9wOiAzNXB4OyBtYXJnaW4tbGVmdDogMjc0cHg7Ij48ZGl2IHN0eWxlPSJib3gtc2l6aW5nOiBib3JkZXItYm94OyBmb250LXNpemU6IDA7IHRleHQtYWxpZ246IGNlbnRlcjsgIj48ZGl2IHN0eWxlPSJkaXNwbGF5OiBpbmxpbmUtYmxvY2s7IGZvbnQtc2l6ZTogMTRweDsgZm9udC1mYW1pbHk6IEhlbHZldGljYTsgY29sb3I6ICNGRkZGRkY7IGxpbmUtaGVpZ2h0OiAxLjI7IHBvaW50ZXItZXZlbnRzOiBhbGw7IHdoaXRlLXNwYWNlOiBub3JtYWw7IHdvcmQtd3JhcDogbm9ybWFsOyAiPjxmb250IGZhY2U9IlZlcmRhbmEiIGNvbG9yPSIjMzQ1MjUzIj48Yj5UYXNrU2V0TWFuYWdlcjwvYj48L2ZvbnQ+PC9kaXY+PC9kaXY+PC9kaXY+PC9mb3JlaWduT2JqZWN0Pjx0ZXh0IHg9IjM1MCIgeT0iMzkiIGZpbGw9IiNGRkZGRkYiIGZvbnQtZmFtaWx5PSJIZWx2ZXRpY2EiIGZvbnQtc2l6ZT0iMTRweCIgdGV4dC1hbmNob3I9Im1pZGRsZSI+VGFza1NldE1hbmFnZXI8L3RleHQ+PC9zd2l0Y2g+PC9nPjwvZz48c3dpdGNoPjxnIHJlcXVpcmVkRmVhdHVyZXM9Imh0dHA6Ly93d3cudzMub3JnL1RSL1NWRzExL2ZlYXR1cmUjRXh0ZW5zaWJpbGl0eSIvPjxhIHRyYW5zZm9ybT0idHJhbnNsYXRlKDAsLTUpIiB4bGluazpocmVmPSJodHRwczovL3d3dy5kaWFncmFtcy5uZXQvZG9jL2ZhcS9zdmctZXhwb3J0LXRleHQtcHJvYmxlbXMiIHRhcmdldD0iX2JsYW5rIj48dGV4dCB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmb250LXNpemU9IjEwcHgiIHg9IjUwJSIgeT0iMTAwJSI+Vmlld2VyIGRvZXMgbm90IHN1cHBvcnQgZnVsbCBTVkcgMS4xPC90ZXh0PjwvYT48L3N3aXRjaD48L3N2Zz4=" width="1402" height="422" class="img_ev3q"></p><p>TaskSetManager 负责监控和管理同一个 Stage 中的任务集（包括 Executor 资源的匹配、任务执行结果的处理等），同时也负责管理本地化调度级别 TaskLocality。</p><div class="theme-admonition theme-admonition-info alert alert--info admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_S0QG"><p>本地化调度是“移动计算”的具体实现，是影响 Spark 性能的关键部分，我们将在启动阶段进行详细介绍。</p></div></div><p>TaskSetManager 有 3 个核心方法：</p><table><thead><tr><th><strong>方法名</strong></th><th><strong>功能描述</strong></th></tr></thead><tbody><tr><td><strong>resourceOffer</strong>(<em>execId</em>, <em>host</em>, <em>maxLocality</em>, <em>taskResourceAssignments</em>)</td><td>为一个任务分配一个 Executor 资源，以描述符 TaskDescription 返回，该描述符包含了 Task、Executor 及依赖包等信息</td></tr><tr><td><strong>handleSuccessfulTask</strong>(<em>tid</em>, <em>result</em>)</td><td>标记任务为成功状态，并通知 DAGScheduler 该任务已完成</td></tr><tr><td><strong>handleFailedTask</strong>(<em>tid</em>, <em>state</em>, <em>reason</em>)</td><td>标记任务为失败状态，并重新加入调度队列</td></tr></tbody></table><p><strong>SchedulableBuilder</strong></p><p>SchedulableBuilder 负责将 TaskSetManager 添加到任务池 rootPool，它有两种实现类：</p><ul><li>FIFOSchedulableBuilder：对应 FIFO 调度策略，以先进先出的顺序添加 TaskSetManager</li><li>FairSchedulableBuilder ：对应 Fair 调度策略，可通过配置控制入队优先级</li></ul><div class="theme-admonition theme-admonition-info alert alert--info admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_S0QG"><p>Fair 调度策略的实现方式比较繁琐，涉及子 Pool 的构建以及优先级的排序等，本文不对此部分内容展开介绍。</p></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="启动阶段">启动阶段<a class="hash-link" href="#启动阶段" title="Direct link to heading">​</a></h3><p>启动阶段指从任务池 rootPool 取出任务并发布到 Executor 的过程。</p><p>相较于提交阶段，启动阶段的调度逻辑要复杂很多，涉及到 <strong>RPC 通信</strong>、<strong>资源的筛选</strong>、<strong>任务与资源的匹配</strong>、<strong>本地化调度</strong> 等。以 Standalone 模式为例，这个过程，简单来说，可以表述为：</p><ol><li>StandaloneSchedulerBackend 的 <code>reviveOffers</code> 方法向 DriverEndPoint 发起 ReviveOffers 请求</li><li>DriverEndPoint 接收到ReviveOffers 请求，触发 <code>makeOffers</code> 方法，筛选出活跃的 Executor 资源，然后以 Seq<!-- -->[WorkerOffer]<!-- --> 的形式发送给 TaskScheduler 的 <code>resourceOffers</code> 方法</li><li>TaskScheduler 获取到 Executor 资源后，会先行过滤，然后通过 <code>Random.shuffle(offers)</code> 将 Executor 资源随机排列，以避免 Task 总是落到同一个 Worker 节点</li><li>排列好资源后，TaskScheduler 便会从 rootPool 提取 TaskSetManager</li><li>TaskSetManager 根据 TaskLocation（由 RDD 的 <code>preferredLocations</code> 方法计算而来）初始化当前任务集所支持的本地化级别 TaskLocality，并将任务所期望的 <code>executorId</code>（Executor 的唯一标识）发送给 PendingTasksByLocality</li><li>TaskScheduler 以当前支持的最大本地化级别分配 Executor 给 Task</li><li>若 Task 存储在 PendingTasksByLocality 的期望 <code>executorId</code> 与分配到的 Executor 一致，则认为分配成功，<strong>并从 PendingTasksByLocality 中移除已配对成功的 Task 的下标，以避免重复分配的现象发生</strong></li><li>若 Task 存储在 PendingTasksByLocality 的期望 <code>executorId</code> 与分配到的 Executor 不一致，则认为分配失败，此时需要降低当前支持的最大本地化级别，并重新配对，直至配对成功</li><li>将配对成功的 Task 与 Executor 封装成 TaskDescription 对象，返回给 DriverEndPoint</li><li>DriverEndPoint 根据 TaskDescription 中的 <code>executorId</code> 从 <code>executorDataMap</code> 取得 Executor 的通信地址，然后将序列化后的 TaskDescription 对象发布给 Executor，至此启动阶段结束</li></ol><div class="theme-admonition theme-admonition-caution alert alert--warning admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>caution</div><div class="admonitionContent_S0QG"><p>若 Task 的 TaskLocation 为空，则 PendingTasksByLocality 会以数组 <code>val noPrefs = new ArrayBuffer[Int]</code> 存储 Task 的下标，并默认以 <code>PROCESS_LOCAL</code> 级别去匹配 Executor 资源。</p></div></div><hr><p><strong><em>知识扩展：Executor 申请成功的时间晚于 <code>reviveOffers</code> 触发的时间，任务会发布失败吗？</em></strong></p><p>在上述 <strong>步骤 1 </strong>和 <strong>步骤 2</strong> 中，Executor 可能在 <code>reviveOffers</code> 触发时还来不及启动，此时会返回空的 WorkerOffer 队列给 TaskScheduler。若出现这种情况，任务难道就直接失败了吗？</p><p>我们先来看看 DriverEndpoint 的 <code>onStart</code> 方法：</p><div class="language-scala codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-scala codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">override</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> onStart</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">Unit</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// Periodically revive offers to allow delay scheduling to work</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">val</span><span class="token plain"> reviveIntervalMs </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> conf</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">SCHEDULER_REVIVE_INTERVAL</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">getOrElse</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1000L</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  reviveThread</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">scheduleAtFixedRate</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">=&gt;</span><span class="token plain"> Utils</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">tryLogNonFatalError </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Option</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">self</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">foreach</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">_</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">send</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ReviveOffers</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> reviveIntervalMs</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> TimeUnit</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">MILLISECONDS</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>该方法会启动一个定时器线程，默认情况下每隔 <code>1s</code> 会向 DriverEndPoint 发起 1 个 ReviveOffers 请求。</p><p>看到这里，想必大家都已经知道答案了。<strong>即便SchedulerBackend 的 <code>reviveOffers</code> 触发时 Executor 还未启动成功，也不影响后续任务的发布。</strong> 因为定时器线程的循环触发意味着 TaskScheduler 的 <code>resourceOffers</code> 方法会被循环调用，这样在后续 Executor 启动成功后它一定有机会获取封装了 Executor 资源的 WorkerOffer 队列以发布任务池中的 Task。</p><hr><p><strong><em>知识扩展：Executor 是一次性分配给所有 Task 还是根据资源数逐一分配？</em></strong></p><p>从 TaskScheduler 的 <code>resourceOffers</code> 方法中，我们截取了以下代码片段：</p><div class="language-scala codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-scala codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">taskSet </span><span class="token keyword" style="color:#00009f">&lt;-</span><span class="token plain"> sortedTaskSets</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// 遍历当前支持的本地化调度级别</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">currentMaxLocality </span><span class="token keyword" style="color:#00009f">&lt;-</span><span class="token plain"> taskSet</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">myLocalityLevels</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 是否能在当前的本地化调度级别下成功分配 Executor 并启动任务</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> launchedTaskAtCurrentMaxLocality </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">do</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic">// 分配 Executor 资源给 TaskSet</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">val</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">noDelayScheduleReject</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> minLocality</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> resourceOfferSingleTaskSet</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        taskSet</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> currentMaxLocality</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> shuffledOffers</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> availableCpus</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        availableResources</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> tasks</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> addressesWithDescs</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic">// 若 minLocality 为空，说明分配失败</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      launchedTaskAtCurrentMaxLocality </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> minLocality</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">isDefined</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      launchedAnyTask </span><span class="token operator" style="color:#393A34">|=</span><span class="token plain"> launchedTaskAtCurrentMaxLocality</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      noDelaySchedulingRejects </span><span class="token operator" style="color:#393A34">&amp;=</span><span class="token plain"> noDelayScheduleReject</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      globalMinLocality </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> minTaskLocality</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">globalMinLocality</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> minLocality</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">while</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">launchedTaskAtCurrentMaxLocality</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>乍看之下，会以为是一次性为 TaskSet 中的所有任务分配 Executor，实际上并非如此，且看 <code>resourceOfferSingleTaskSet</code> 中的核心代码：</p><div class="language-scala codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-scala codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// 遍历 Executor 资源</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">i </span><span class="token keyword" style="color:#00009f">&lt;-</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> until shuffledOffers</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">size</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">val</span><span class="token plain"> execId </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> shuffledOffers</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">executorId</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">val</span><span class="token plain"> host </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> shuffledOffers</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">host</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">val</span><span class="token plain"> taskSetRpID </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> taskSet</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">taskSet</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">resourceProfileId</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">taskSetRpID </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> shuffledOffers</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">resourceProfileId</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 是否有多余的 CPU 资源，若没有，跳过</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">val</span><span class="token plain"> taskResAssignmentsOpt </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> resourcesMeetTaskRequirements</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">taskSet</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> availableCpus</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> availableResources</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    taskResAssignmentsOpt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">foreach </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> taskResAssignments </span><span class="token keyword" style="color:#00009f">=&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">try</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// 分配 Executor 给某个 Task，若 Executor 与 Task 的预期 Executor 不匹配，则返回空</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">val</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">taskDescOption</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> didReject</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> taskSet</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">resourceOffer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">execId</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> host</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> maxLocality</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> taskResAssignments</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>简单阅读后发现，在 <code>resourceOfferSingleTaskSet</code> 中，是根据 Executor 的数量及其空闲 CPU 数来进行资源配对的。假设 TaskSet 中有 3 个 Task，Executor 数为 1 且可用 CPU 核数为 1，那么 <code>resourceOfferSingleTaskSet</code>  只会分配 Executor 给 <code>tasks(0)</code>，即 TaskSet 中的第一个 Task。分配后，由于没有可用的 CPU 资源，<code>resourcesMeetTaskRequirements</code> 方法会返回空，使得 <code>resourceOfferSingleTaskSet</code> 返回空的 <code>minLocality</code> ，造成循环跳出，最终导致剩余的 2 个 Task 在本次 <code>resourceOffers</code> 调度中不会分配到 Executor。</p><p>看到这里，我们不禁产生疑问，<code>resourceOffers</code> 调用的 <strong>源头之一</strong> 是 SchedulerBackend 的 <code>reviveOffers()</code> 方法，且该方法只在提交阶段由 <code>sumbitTasks</code> 触发一次，那么剩下的 2 个 Task 要怎么去匹配 Executor 资源？</p><p><strong>实际上，DriverEndPoint 的 <code>receive</code> 方法不仅仅是在接收到 ReviveOffers 请求时会触发 <code>resourceOffers</code>，在接收到 StatusUpdate 也可以。</strong> 这句话用一种更直观的方式表述就是，当 Executor 资源不足时，会先分配给序号靠前的 Task，当这些 Task 完成后，会释放占用的 Executor 核数，并在通知 DriverEndPoint 任务完成的同时触发 <code>resourceOffers</code>，使后面的 Task 可以享用已经空闲的 Executor，如下图所示：</p><p><img loading="lazy" src="/assets/images/resource_offer-9b01b847231f4942a52f42170e776a63.svg" width="1843" height="863" class="img_ev3q"></p><div class="theme-admonition theme-admonition-info alert alert--info admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_S0QG"><p>由于上述定时器线程的存在，即便 DriverEndPoint 在接收到 StatusUpdate 后不再触发 <code>resourceOffers</code>，剩余的任务也依旧可以发布出去。至于为什么 TaskScheduler 的 <code>resourceOffers</code> 方法会存在这种重复调用的情况，笔者猜测是为了兼容不同的集群部署模式。</p></div></div><hr><p><strong><em>知识扩展：本地化调度是什么？支持哪些级别？</em></strong></p><p>“移动计算”，即将计算任务移动到数据所在节点，是大数据计算中提升性能的一种手段。Spark 中的本地化调度机制，就是“移动计算”的实现方案。</p><p>从 RDD 的 <code>preferredLocations</code> 方法，我们可以获得 Seq<!-- -->[TaskLocation]<!-- -->，它表示 RDD 分区所对应计算任务应该执行的位置。由于 TaskLocation 有多种实现类，其指向的位置也有多种，可能是在 <strong>内存</strong>，可能是在 <strong>磁盘</strong>，也可能是在 <strong>分布式文件系统</strong> 中。如果是在内存，我们希望 Task 发往内存中含有这个数据的 Executor；如果是在磁盘，我们希望 Task 发往存储着数据的服务器节点。</p><p>根据这个目标，Spark 支持了 5 种级别的本地化调度方式，按优先级由高到低排序依次为：</p><table><thead><tr><th><strong>级别</strong></th><th><strong>含义</strong></th></tr></thead><tbody><tr><td>PROCESS_LOCAL</td><td>进程本地化，Task 和数据在同一个 Executor 中，性能最好</td></tr><tr><td>NODE_LOCAL</td><td>节点本地化，Task 和数据在同一个节点但是不在同一个 Executor，数据需要在进程间进行传输</td></tr><tr><td>NO_PREF</td><td>对于 Task 来说，从哪里获取都一样，没有好坏之分</td></tr><tr><td>RACK_LOCAL</td><td>机架本地化，Task 和数据在同一个机架的两个节点上，数据需要通过网络在节点之间进行传输</td></tr><tr><td>ANY</td><td>Task 和数据可以在集群的任何地方，甚至不在一个机架中，性能最差</td></tr></tbody></table><div class="theme-admonition theme-admonition-info alert alert--info admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_S0QG"><p>本地化调度级别按枚举值从高到低排序为 <code>ANY</code> → <code>RACK_LOCAL</code> → <code>NO_PREF</code> → <code>NODE_LOCAL</code> → <code>PROCESS_LOCAL</code>。</p></div></div><hr><p><strong><em>知识扩展：本地化调度是怎么“移动计算”的？调度失败会如何？</em></strong></p><p>“移动计算”的本质是，已知数据的位置，将计算任务移动至数据所在位置。为实现这个目的，本地化调度做了两件事：</p><ul><li>初始化 PendingTasksByLocality，记录每个 Task 所期望的 Executor 集合</li><li>比对 SchedulerBackend 所持有的真实的 Executor 资源，若与预期相符，则完成匹配，否则降级调度</li></ul><p>当 TaskSetManager 创建时，会初始化 PendingTasksByLocality。PendingTasksByLocality 中含有 3 个核心变量：</p><table><thead><tr><th><strong>变量名称</strong></th><th><strong>含义</strong></th></tr></thead><tbody><tr><td>forExecutor</td><td>存储所有任务期望的符合 PROCESS_LOCAL 级别的 <code>executorId</code></td></tr><tr><td>forHost</td><td>存储所有任务期望的符合 NODE_LOCAL 级别的 <code>executorId</code></td></tr><tr><td>noPrefs</td><td>存储所有任务期望的符合 RACK_LOCAL 级别的 <code>executorId</code></td></tr></tbody></table><p>其中，各变量的初始化过程可见源码：</p><div class="language-scala codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-scala codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// 遍历 Seq[TaskLocation]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">loc </span><span class="token keyword" style="color:#00009f">&lt;-</span><span class="token plain"> tasks</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">index</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">preferredLocations</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// 初始化 PROCESS_LOCAL 级别的 Executor 集合</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  loc </span><span class="token keyword" style="color:#00009f">match</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> e</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> ExecutorCacheTaskLocation </span><span class="token keyword" style="color:#00009f">=&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      pendingTaskSetToAddTo</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">forExecutor</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">getOrElseUpdate</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">e</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">executorId</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> ArrayBuffer</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> index</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> e</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> HDFSCacheTaskLocation </span><span class="token keyword" style="color:#00009f">=&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">val</span><span class="token plain"> exe </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> sched</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">getExecutorsAliveOnHost</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">loc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">host</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      exe </span><span class="token keyword" style="color:#00009f">match</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> Some</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">set</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">=&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">e </span><span class="token keyword" style="color:#00009f">&lt;-</span><span class="token plain"> set</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            pendingTaskSetToAddTo</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">forExecutor</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">getOrElseUpdate</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">e</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> ArrayBuffer</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> index</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          logInfo</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string-interpolation id function" style="color:#d73a49">s</span><span class="token string-interpolation string" style="color:#e3116c">&quot;Pending task </span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">$</span><span class="token string-interpolation interpolation expression">index</span><span class="token string-interpolation string" style="color:#e3116c"> has a cached location at </span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">${</span><span class="token string-interpolation interpolation expression">e</span><span class="token string-interpolation interpolation expression punctuation" style="color:#393A34">.</span><span class="token string-interpolation interpolation expression">host</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c"> &quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token string" style="color:#e3116c">&quot;, where there are executors &quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> set</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">mkString</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;,&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> None </span><span class="token keyword" style="color:#00009f">=&gt;</span><span class="token plain"> logDebug</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string-interpolation id function" style="color:#d73a49">s</span><span class="token string-interpolation string" style="color:#e3116c">&quot;Pending task </span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">$</span><span class="token string-interpolation interpolation expression">index</span><span class="token string-interpolation string" style="color:#e3116c"> has a cached location at </span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">${</span><span class="token string-interpolation interpolation expression">e</span><span class="token string-interpolation interpolation expression punctuation" style="color:#393A34">.</span><span class="token string-interpolation interpolation expression">host</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c"> &quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token string" style="color:#e3116c">&quot;, but there are no executors alive there.&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> _ </span><span class="token keyword" style="color:#00009f">=&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// 初始化 NODE_LOCAL 级别的 Executor 集合</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  pendingTaskSetToAddTo</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">forHost</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">getOrElseUpdate</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">loc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">host</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> ArrayBuffer</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> index</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// 初始化 RACK_LOCAL 级别的 Executor 集合</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">resolveRacks</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    sched</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">getRackForHost</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">loc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">host</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">foreach </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> rack </span><span class="token keyword" style="color:#00009f">=&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      pendingTaskSetToAddTo</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">forRack</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">getOrElseUpdate</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">rack</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> ArrayBuffer</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> index</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">tasks</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">index</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">preferredLocations </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> Nil</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  pendingTaskSetToAddTo</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">noPrefs </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> index</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pendingTaskSetToAddTo</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">all </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> index</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>当 TaskScheduler 的 <code>resourceOfferSingleTaskSet</code> 方法供给 Executor 资源时，TaskSetManager 的 <code>resourceOffer</code> 方法会通过调用 <code>dequeueTaskHelper</code> 确认期望的 <code>executorId</code> 是否与供给的 <code>executorId</code> 匹配，若认为配对成功，便返回 TaskDescription 对象，否则重新匹配。其源码的核心内容如下：</p><div class="language-scala codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-scala codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// forExecutor 中的资源是否有与 execId 相匹配的资源，若有，直接返回</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">dequeue</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">pendingTaskSetToUse</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">forExecutor</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">getOrElse</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">execId</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> ArrayBuffer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">foreach </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> index </span><span class="token keyword" style="color:#00009f">=&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> Some</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">index</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> TaskLocality</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">PROCESS_LOCAL</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> speculative</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// 当前支持的最大调度级别的枚举值是否大于 NODE_LOCAL</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// maxLocality = NODE_LOCAL/NO_PREF/RACK_LOCAL/ANY 时触发</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">TaskLocality</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">isAllowed</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">maxLocality</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> TaskLocality</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">NODE_LOCAL</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// forHost 中的资源是否有与 execId 相匹配的资源，若有，直接返回</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  dequeue</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">pendingTaskSetToUse</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">forHost</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">getOrElse</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">host</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> ArrayBuffer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">foreach </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> index </span><span class="token keyword" style="color:#00009f">=&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> Some</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">index</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> TaskLocality</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">NODE_LOCAL</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> speculative</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// maxLocality = NO_PREF/RACK_LOCAL/ANY 时触发</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">TaskLocality</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">isAllowed</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">maxLocality</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> TaskLocality</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">NO_PREF</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  dequeue</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">pendingTaskSetToUse</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">noPrefs</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">foreach </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> index </span><span class="token keyword" style="color:#00009f">=&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> Some</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">index</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> TaskLocality</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">PROCESS_LOCAL</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> speculative</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// maxLocality = RACK_LOCAL/ANY 时触发</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">TaskLocality</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">isAllowed</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">maxLocality</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> TaskLocality</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">RACK_LOCAL</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    rack </span><span class="token keyword" style="color:#00009f">&lt;-</span><span class="token plain"> sched</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">getRackForHost</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">host</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    index </span><span class="token keyword" style="color:#00009f">&lt;-</span><span class="token plain"> dequeue</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">pendingTaskSetToUse</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">forRack</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">getOrElse</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">rack</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> ArrayBuffer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> Some</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">index</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> TaskLocality</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">RACK_LOCAL</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> speculative</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// maxLocality = ANY 时触发</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">TaskLocality</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">isAllowed</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">maxLocality</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> TaskLocality</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ANY</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  dequeue</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">pendingTaskSetToUse</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">all</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">foreach </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> index </span><span class="token keyword" style="color:#00009f">=&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> Some</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">index</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> TaskLocality</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ANY</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> speculative</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">None</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="theme-admonition theme-admonition-caution alert alert--warning admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>caution</div><div class="admonitionContent_S0QG"><p>PendingTasksByLocality 中的预期资源在匹配成功后会被移除，以避免可用资源充足的情况下发生重复分配，具体可参考 <code>dequeueTaskFromList</code> 方法。</p></div></div><p>当然，梦想不可能总成为现实，有时候期望的 Executor 资源无法在 <code>spark.locality.wait</code> 指定的时间范围内及时获取，此时会触发本地化调度级别的降级过程：<strong>仍然尝试以当前本地化调度级别发布任务，若依旧失败，则降低级别，尝试将期望级别较低的 Executor 资源提供给 Task，直至成功。</strong></p><div class="theme-admonition theme-admonition-info alert alert--info admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_S0QG"><p>如果发现大量计算任务的本地化调度级别跨节点甚至是跨机架，可以考虑增加 <code>spark.locality.wait</code> 的值，以适当提高本地化调度的等待时间。但是在大多数情况下，默认值 <code>3s</code> 是可以有效运作的。</p></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="执行阶段">执行阶段<a class="hash-link" href="#执行阶段" title="Direct link to heading">​</a></h3><p>执行阶段由 Executor 负责。</p><p>在 Standalone 模式下，Executor 由独立的 JVM 进程 CoarseGrainedExecutorBackend 创建。</p><p>Executor 的 <code>launchTask</code> 方法会启动执行阶段，它会将 TaskDescription 封装成 TaskRunner，然后交由线程池执行。当 TaskRunner 的 <code>run</code> 方法被线程池调度后，一个计算任务的执行就正式开始了。</p><p><strong>STEP 01：依赖包下载</strong></p><p>Driver 端在发布任务的时候，会将所需的依赖信息注入到 TaskDescription 对象中。在 Executor 执行计算之前，需要先调用 <code>updateDependencies</code> 方法下载所需依赖包，并将其添加至 ClassLoader 中，以确保 Executor 完全具备执行 Task 的能力，关键代码如下所示：</p><div class="language-scala codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-scala codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// Fetch file with useCache mode, close cache for local mode.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Utils</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">fetchFile</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">name</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> File</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">SparkFiles</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">getRootDirectory</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> conf</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> env</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">securityManager</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  hadoopConf</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> timestamp</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> useCache </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!</span><span class="token plain">isLocal</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// Add it to our class loader</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">val</span><span class="token plain"> url </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> File</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">SparkFiles</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">getRootDirectory</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> localName</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">toURI</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">toURL</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">!</span><span class="token plain">urlClassLoader</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">getURLs</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">contains</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">url</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  urlClassLoader</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">addURL</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">url</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>STEP 02：执行计算</strong></p><p>下载完依赖后，Executor 会将 TaskDescription 中的 <code>serializedTask</code> 反序列化为 Task 对象，然后通过 Task 对象的 <code>runTask</code> 方法执行计算。<code>runTask</code> 方法是抽象类，需要子类负责实现，所以真实的计算逻辑由 Task 的子类决定。</p><p>在 Spark 中，Task 的子类有 ShuffleMapTask 和 ResultTask 两种。前者表示 ShuffleMapStage 中的任务；后者表示最终响应数据给 Application 的任务。</p><p>若 Task 为 ShuffleMapTask，则 <code>runTask</code> 主要做的事情为：</p><ul><li>反序列化字节数组 <code>taskBinary</code>，获得 RDD 和 ShuffleDependency 实例</li><li>从 SparkEnv 中获取 ShuffleManager，并通过 ShuffleManager 获取 ShuffleWriter 实例</li><li>调用 RDD 的 <code>iterator</code> 方法执行计算，并使用 ShuffleWriter 将计算结果写入到 Executor 端的存储系统</li><li><strong>返回 MapStatus 对象</strong>，该对象包含了 Executor 端的 BlockManager 地址</li></ul><p>若 Task 为 ResultTask，则 <code>runTask</code> 主要做的事情为：</p><ul><li>反序列化字节数组 <code>taskBinary</code>，获得 RDD 实例和用户函数 <code>func</code></li><li>调用 RDD 的 <code>iterator</code> 方法获取迭代器，将其作为参数传入用户函数 <code>func</code> 执行计算，并 <strong>直接返回计算后的结果</strong></li></ul><div class="theme-admonition theme-admonition-info alert alert--info admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_S0QG"><p><code>iterator</code> 方法最终实际上调用的便是 RDD 的 <code>compute</code> 方法，<code>compute</code> 方法的具体实现由子类决定。</p></div></div><hr><p><strong>知识扩展：用户函数 <code>func</code> 与 RDD 的 <code>compute</code> 方法是什么关系？哪一个是计算逻辑的执行者？</strong></p><p>用户函数 <code>func</code> 指的便是我们编写在算子中的计算逻辑，例如：</p><div class="language-scala codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-scala codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// 转换算子中的 func</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">val</span><span class="token plain"> wordMap</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> RDD</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">(</span><span class="token builtin">String</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token builtin">Int</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> words</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">map</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x </span><span class="token keyword" style="color:#00009f">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// 行动算子中的 func</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rdd</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">foreach</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x </span><span class="token keyword" style="color:#00009f">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  println</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token builtin">String</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">value</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> StandardCharsets</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">UTF_8</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>直觉告诉我们，用户函数 <code>func</code> 会在 RDD 的 <code>compute</code> 方法中被调用，因此两者都可以算作计算逻辑的执行者，但实际上真的是如此吗？</p><p>举例说明，如果仅看 MapPartitionsRDD 的 <code>compute</code> 方法，那么上面的结论是正确的：</p><div class="language-scala codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-scala codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">override</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> compute</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">split</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Partition</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> context</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> TaskContext</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Iterator</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">U</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  f</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">context</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> split</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">index</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> firstParent</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">T</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">iterator</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">split</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> context</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>但在 KafkaRDD 中（以 <code>0.8</code> 版本为例），这个结论却是错误的，我们在 <code>compute</code> 方法看不到用户函数 <code>func</code> 的身影，只能看到它返回了一个数据集的迭代器：</p><div class="language-scala codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-scala codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">override</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> compute</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">thePart</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Partition</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> context</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> TaskContext</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Iterator</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">R</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">val</span><span class="token plain"> part </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> thePart</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">asInstanceOf</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">KafkaRDDPartition</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  assert</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">part</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">fromOffset </span><span class="token operator" style="color:#393A34">&lt;=</span><span class="token plain"> part</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">untilOffset</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> errBeginAfterEnd</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">part</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">part</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">fromOffset </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> part</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">untilOffset</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">info</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string-interpolation id function" style="color:#d73a49">s</span><span class="token string-interpolation string" style="color:#e3116c">&quot;Beginning offset </span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">${</span><span class="token string-interpolation interpolation expression">part</span><span class="token string-interpolation interpolation expression punctuation" style="color:#393A34">.</span><span class="token string-interpolation interpolation expression">fromOffset</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c"> is the same as ending offset &quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token string-interpolation id function" style="color:#d73a49">s</span><span class="token string-interpolation string" style="color:#e3116c">&quot;skipping </span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">${</span><span class="token string-interpolation interpolation expression">part</span><span class="token string-interpolation interpolation expression punctuation" style="color:#393A34">.</span><span class="token string-interpolation interpolation expression">topic</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c"> </span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">${</span><span class="token string-interpolation interpolation expression">part</span><span class="token string-interpolation interpolation expression punctuation" style="color:#393A34">.</span><span class="token string-interpolation interpolation expression">partition</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Iterator</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">empty</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> KafkaRDDIterator</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">part</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> context</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>所以结论是，用户函数 <code>func</code> 是计算逻辑的执行者，而 RDD 的 <code>compute</code> 方法是否参与了计算的执行还需要看其子类的具体实现。但有一点是肯定的，对于 ResultTask 而言，用户函数 <code>func</code> 和 RDD 的 <code>compute</code> 方法共同完成了计算逻辑的执行：</p><div class="language-scala codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-scala codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">override</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> runTask</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">context</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> TaskContext</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> U </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// Deserialize the RDD and the func using the broadcast variables.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">val</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">rdd</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> func</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> ser</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">deserialize</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">RDD</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">T</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">TaskContext</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> Iterator</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">T</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">=&gt;</span><span class="token plain"> U</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ByteBuffer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">wrap</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">taskBinary</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">value</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> Thread</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">currentThread</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">getContextClassLoader</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  func</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">context</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> rdd</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">iterator</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">partition</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> context</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>STEP 03：处理计算结果</strong></p><p>我们先了解两个与计算结果相关的类的概念：</p><table><thead><tr><th><strong>类名称</strong></th><th><strong>含义</strong></th></tr></thead><tbody><tr><td>DirectTaskResult</td><td>表示直接计算结果，以 ByteBuffer 存储计算后的结果</td></tr><tr><td>IndirectTaskResult</td><td>表示间接计算结果，仅存储 DirectTaskResult 在 BlockManager 的引用及其大小</td></tr></tbody></table><p>Executor 完成计算后，首先会对计算结果进行序列化，得到 DirectTaskResult 对象，主要代码如下：</p><div class="language-scala codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-scala codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">val</span><span class="token plain"> ser </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> env</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">closureSerializer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">newInstance</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">val</span><span class="token plain"> resultSer </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> env</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">serializer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">newInstance</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">val</span><span class="token plain"> valueBytes </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> resultSer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">serialize</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">value</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">val</span><span class="token plain"> directResult </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> DirectTaskResult</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">valueBytes</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> accumUpdates</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> metricPeaks</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">val</span><span class="token plain"> serializedDirectResult </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> ser</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">serialize</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">directResult</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// 序列化结果的大小</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">val</span><span class="token plain"> resultSize </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> serializedDirectResult</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">limit</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>根据 <code>resultSize</code> 的大小，Executor 采用了 3 种不同的方式处理计算结果：</p><ul><li>若 <code>resultSize</code> &gt; <code>maxResultSize</code>，直接丢弃并转化为 IndirectTaskResult 回传给 Driver</li><li>若 <code>resultSize</code> &gt; <code>maxDirectResultSize</code>，存储到 BlockManager 并转化为 IndirectTaskResult 回传给 Driver</li><li>若 <code>resultSize</code> 不符合以上两种情况，直接回传给 Driver</li></ul><div class="theme-admonition theme-admonition-info alert alert--info admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_S0QG"><p><code>maxResultSize</code> 表示最大结果大小，由 Spark 配置参数 <code>spark.driver.maxResultSize</code> 指定，默认值为 <code>1g</code>；<code>maxDirectResultSize</code> 表示最大直接回传结果大小，由 Spark 配置参数 <code>spark.task.maxDirectResultSize</code> 和 <code>spark.rpc.message.maxSize</code> 中的最小值决定，前者默认值为 <code>1MB</code>，后者默认值为 <code>128MB</code>。</p></div></div><div class="theme-admonition theme-admonition-caution alert alert--warning admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>caution</div><div class="admonitionContent_S0QG"><p>若任务类型为 ShuffleMapTask，尽管返回给 Driver 的结果也是 DirectTaskResult，但实际上封装的是 MapStatus 的信息，并非真实的计算结果。</p></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="回收阶段">回收阶段<a class="hash-link" href="#回收阶段" title="Direct link to heading">​</a></h3><p>回收阶段由 ExecutorBackend 的 <code>statusUpdate</code> 方法发起，在 Standalone 模式下，主要过程为：</p><ol><li>构造 StatusUpdate 对象（包含 <code>executorId</code>、<code>taskId</code>、<code>state</code>、<code>data</code> 等字段），发给 DriverEndPoint</li><li>DriverEndPoint 接收请求后，调用 TaskScheduler 的 <code>statusUpdate</code> 方法接收回收任务</li><li>若任务状态为 <code>FINISHED</code>，TaskResultGetter 的 <code>enqueueSuccessfulTask</code> 方法会对回收任务进行异步处理：<ul><li>若接收结果为 DirectTaskResult，直接获取计算结果返回值</li><li>若接收结果为 IndirectTaskResult，则先通过 <code>blockId</code> 找到 BlockManager，再获取计算结果返回值</li></ul></li><li>调用 TaskSetManager 的 <code>handleSuccessfulTask</code> 方法，标记任务执行结果，并通知 DAGScheduler</li><li>DAGScheduler 通过 <code>handleTaskCompletion</code> 方法完成最终的回收：<ul><li>若任务类型为 ShuffleMapTask，<strong>将 MapStatus 注册到 MapOutputTracker</strong>，然后继续提交队列中的任务</li><li>若任务类型为 ResultTask，标记 Job 为结束状态，<strong>上报计算结果到 JobWaiter 并回传给 Application</strong></li></ul></li></ol><div class="theme-admonition theme-admonition-info alert alert--info admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_S0QG"><p>本节只展示成功任务的回收过程，不描述失败任务的回收及重发过程。</p></div></div><p>看到 JobWaiter，有些人可能会有些陌生。实际上，它不仅是任务调度的终点，也是任务调度的起点。回顾一下，我们最初触发行动算子时，会调用到 SparkContext 的 <code>runJob</code> 方法：</p><div class="language-scala codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-scala codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> runJob</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">T</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> U</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> ClassTag</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    rdd</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> RDD</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">T</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    func</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">TaskContext</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> Iterator</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">T</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">=&gt;</span><span class="token plain"> U</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    partitions</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Seq</span><span class="token punctuation" style="color:#393A34">[</span><span class="token builtin">Int</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Array</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">U</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">val</span><span class="token plain"> results </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> Array</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">U</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">partitions</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">size</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  runJob</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">T</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> U</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">rdd</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> func</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> partitions</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">index</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> res</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">=&gt;</span><span class="token plain"> results</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">index</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> res</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  results</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>其中的 <code>results</code> 即为返回给 Application 的结果，它的赋值最终由 JobWaiter 完成，整个过程的核心代码如下：</p><div class="language-scala codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-scala codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// DAGScheduler</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">val</span><span class="token plain"> waiter </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> submitJob</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">rdd</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> func</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> partitions</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> callSite</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> resultHandler</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> properties</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// JobWaiter</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">override</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> taskSucceeded</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">index</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">Int</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> result</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">Any</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">Unit</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  synchronized </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    resultHandler</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">index</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> result</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">asInstanceOf</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">T</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">finishedTasks</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">incrementAndGet</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> totalTasks</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    jobPromise</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">success</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>至此，我们完成了对 Spark 任务调度整个过程的梳理，但是仔细思索的话，我们会发现还有一些很重要的问题没有展开讨论，那就是：<strong>ResultTask 是怎么获得 ShuffleMapTask 中的计算结果的？两者之间究竟是通过什么方式完成数据传递？</strong></p><p>这一切，都将在我们的下一篇文章《Spark Shuffle》中得到解答。</p></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/spark/Spark 共享变量"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Spark 共享变量</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/spark/Spark Shuffle"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Spark Shuffle</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#任务调度概述" class="table-of-contents__link toc-highlight">任务调度概述</a><ul><li><a href="#基本概念" class="table-of-contents__link toc-highlight">基本概念</a></li><li><a href="#调度流程" class="table-of-contents__link toc-highlight">调度流程</a></li></ul></li><li><a href="#stage-划分" class="table-of-contents__link toc-highlight">Stage 划分</a><ul><li><a href="#基本概念-1" class="table-of-contents__link toc-highlight">基本概念</a></li><li><a href="#划分规则" class="table-of-contents__link toc-highlight">划分规则</a></li><li><a href="#代码实现" class="table-of-contents__link toc-highlight">代码实现</a></li></ul></li><li><a href="#rpc-模块" class="table-of-contents__link toc-highlight">RPC 模块</a><ul><li><a href="#核心概念" class="table-of-contents__link toc-highlight">核心概念</a></li><li><a href="#通信过程" class="table-of-contents__link toc-highlight">通信过程</a></li></ul></li><li><a href="#task-调度" class="table-of-contents__link toc-highlight">Task 调度</a><ul><li><a href="#初始化阶段" class="table-of-contents__link toc-highlight">初始化阶段</a></li><li><a href="#提交阶段" class="table-of-contents__link toc-highlight">提交阶段</a></li><li><a href="#启动阶段" class="table-of-contents__link toc-highlight">启动阶段</a></li><li><a href="#执行阶段" class="table-of-contents__link toc-highlight">执行阶段</a></li><li><a href="#回收阶段" class="table-of-contents__link toc-highlight">回收阶段</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Recommend</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs">Spark</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/flink">Flink</a></li></ul></div><div class="col footer__col"><div class="footer__title">Other</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs/clickhouse">ClickHouse</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/flume">Flume</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/spider">Spider</a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/magicpenta" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">Legal</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://opensource.fb.com/legal/privacy/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Privacy<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://opensource.fb.com/legal/cookie-policy/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Cookie Policy<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="margin-bottom--sm"><img src="/img/bottom.png" alt="Panda Logo" class="themedImage_ToTc themedImage--light_HNdA footer__logo"><img src="/img/bottom.png" alt="Panda Logo" class="themedImage_ToTc themedImage--dark_i4oU footer__logo"></div><div class="footer__copyright">Copyright © 2023 Panda's Home</div></div></div></footer></div>
<script src="/assets/js/runtime~main.e2f7f3df.js"></script>
<script src="/assets/js/main.4ed9c8f6.js"></script>
</body>
</html>